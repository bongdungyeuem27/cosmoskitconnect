(function(v,ie){typeof exports=="object"&&typeof module<"u"?ie(exports,require("@cosmoskitconnect/heartbeat"),require("@cosmoskitconnect/relay-auth"),require("@cosmoskitconnect/utils"),require("@cosmoskitconnect/jsonrpc-ws-connection")):typeof define=="function"&&define.amd?define(["exports","@cosmoskitconnect/heartbeat","@cosmoskitconnect/relay-auth","@cosmoskitconnect/utils","@cosmoskitconnect/jsonrpc-ws-connection"],ie):(v=typeof globalThis<"u"?globalThis:v||self,ie(v["@cosmoskitconnect/core"]={},v.heartbeat,v.s$3,v.utils,v.M$2))})(this,function(v,ie,Et,g,$s){"use strict";function zs(i){return i&&typeof i=="object"&&"default"in i?i:{default:i}}function js(i){if(i&&i.__esModule)return i;var e=Object.create(null);return i&&Object.keys(i).forEach(function(t){if(t!=="default"){var r=Object.getOwnPropertyDescriptor(i,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:function(){return i[t]}})}}),e.default=i,Object.freeze(e)}var He=js(Et),Us=zs($s),Ye=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},re={exports:{}},De=typeof Reflect=="object"?Reflect:null,ti=De&&typeof De.apply=="function"?De.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},Xe;De&&typeof De.ownKeys=="function"?Xe=De.ownKeys:Object.getOwnPropertySymbols?Xe=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Xe=function(e){return Object.getOwnPropertyNames(e)};function Ms(i){console&&console.warn&&console.warn(i)}var ii=Number.isNaN||function(e){return e!==e};function T(){T.init.call(this)}re.exports=T,re.exports.once=Vs,T.EventEmitter=T,T.prototype._events=void 0,T.prototype._eventsCount=0,T.prototype._maxListeners=void 0;var ri=10;function We(i){if(typeof i!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i)}Object.defineProperty(T,"defaultMaxListeners",{enumerable:!0,get:function(){return ri},set:function(i){if(typeof i!="number"||i<0||ii(i))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+i+".");ri=i}}),T.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},T.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ii(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function si(i){return i._maxListeners===void 0?T.defaultMaxListeners:i._maxListeners}T.prototype.getMaxListeners=function(){return si(this)},T.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var s=e==="error",n=this._events;if(n!==void 0)s=s&&n.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var h=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw h.context=o,h}var u=n[e];if(u===void 0)return!1;if(typeof u=="function")ti(u,this,t);else for(var c=u.length,d=hi(u,c),r=0;r<c;++r)ti(d[r],this,t);return!0};function ni(i,e,t,r){var s,n,o;if(We(t),n=i._events,n===void 0?(n=i._events=Object.create(null),i._eventsCount=0):(n.newListener!==void 0&&(i.emit("newListener",e,t.listener?t.listener:t),n=i._events),o=n[e]),o===void 0)o=n[e]=t,++i._eventsCount;else if(typeof o=="function"?o=n[e]=r?[t,o]:[o,t]:r?o.unshift(t):o.push(t),s=si(i),s>0&&o.length>s&&!o.warned){o.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=i,h.type=e,h.count=o.length,Ms(h)}return i}T.prototype.addListener=function(e,t){return ni(this,e,t,!1)},T.prototype.on=T.prototype.addListener,T.prototype.prependListener=function(e,t){return ni(this,e,t,!0)};function Bs(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function oi(i,e,t){var r={fired:!1,wrapFn:void 0,target:i,type:e,listener:t},s=Bs.bind(r);return s.listener=t,r.wrapFn=s,s}T.prototype.once=function(e,t){return We(t),this.on(e,oi(this,e,t)),this},T.prototype.prependOnceListener=function(e,t){return We(t),this.prependListener(e,oi(this,e,t)),this},T.prototype.removeListener=function(e,t){var r,s,n,o,h;if(We(t),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(n=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){h=r[o].listener,n=o;break}if(n<0)return this;n===0?r.shift():Fs(r,n),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,h||t)}return this},T.prototype.off=T.prototype.removeListener,T.prototype.removeAllListeners=function(e){var t,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var n=Object.keys(r),o;for(s=0;s<n.length;++s)o=n[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function ai(i,e,t){var r=i._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?Ks(s):hi(s,s.length)}T.prototype.listeners=function(e){return ai(this,e,!0)},T.prototype.rawListeners=function(e){return ai(this,e,!1)},T.listenerCount=function(i,e){return typeof i.listenerCount=="function"?i.listenerCount(e):ci.call(i,e)},T.prototype.listenerCount=ci;function ci(i){var e=this._events;if(e!==void 0){var t=e[i];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}T.prototype.eventNames=function(){return this._eventsCount>0?Xe(this._events):[]};function hi(i,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=i[r];return t}function Fs(i,e){for(;e+1<i.length;e++)i[e]=i[e+1];i.pop()}function Ks(i){for(var e=new Array(i.length),t=0;t<e.length;++t)e[t]=i[t].listener||i[t];return e}function Vs(i,e){return new Promise(function(t,r){function s(o){i.removeListener(e,n),r(o)}function n(){typeof i.removeListener=="function"&&i.removeListener("error",s),t([].slice.call(arguments))}li(i,e,n,{once:!0}),e!=="error"&&ks(i,s,{once:!0})})}function ks(i,e,t){typeof i.on=="function"&&li(i,"error",e,t)}function li(i,e,t,r){if(typeof i.on=="function")r.once?i.once(e,t):i.on(e,t);else if(typeof i.addEventListener=="function")i.addEventListener(e,function s(n){r.once&&i.removeEventListener(e,s),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof i)}const Gs=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,qs=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,Hs=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function Ys(i,e){if(i==="__proto__"||i==="constructor"&&e&&typeof e=="object"&&"prototype"in e){Xs(i);return}return e}function Xs(i){console.warn(`[destr] Dropping "${i}" key to prevent prototype pollution.`)}function Je(i,e={}){if(typeof i!="string")return i;const t=i.trim();if(i[0]==='"'&&i.endsWith('"')&&!i.includes("\\"))return t.slice(1,-1);if(t.length<=9){const r=t.toLowerCase();if(r==="true")return!0;if(r==="false")return!1;if(r==="undefined")return;if(r==="null")return null;if(r==="nan")return Number.NaN;if(r==="infinity")return Number.POSITIVE_INFINITY;if(r==="-infinity")return Number.NEGATIVE_INFINITY}if(!Hs.test(i)){if(e.strict)throw new SyntaxError("[destr] Invalid JSON");return i}try{if(Gs.test(i)||qs.test(i)){if(e.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(i,Ys)}return JSON.parse(i)}catch(r){if(e.strict)throw r;return i}}function Ws(i){return!i||typeof i.then!="function"?Promise.resolve(i):i}function N(i,...e){try{return Ws(i(...e))}catch(t){return Promise.reject(t)}}function Js(i){const e=typeof i;return i===null||e!=="object"&&e!=="function"}function Zs(i){const e=Object.getPrototypeOf(i);return!e||e.isPrototypeOf(Object)}function Ze(i){if(Js(i))return String(i);if(Zs(i)||Array.isArray(i))return JSON.stringify(i);if(typeof i.toJSON=="function")return Ze(i.toJSON());throw new Error("[unstorage] Cannot stringify value!")}const _t="base64:";function Qs(i){return typeof i=="string"?i:_t+rn(i)}function en(i){return typeof i!="string"||!i.startsWith(_t)?i:tn(i.slice(_t.length))}function tn(i){return globalThis.Buffer?Buffer.from(i,"base64"):Uint8Array.from(globalThis.atob(i),e=>e.codePointAt(0))}function rn(i){return globalThis.Buffer?Buffer.from(i).toString("base64"):globalThis.btoa(String.fromCodePoint(...i))}function B(i){return i&&i.split("?")[0]?.replace(/[/\\]/g,":").replace(/:+/g,":").replace(/^:|:$/g,"")||""}function sn(...i){return B(i.join(":"))}function Qe(i){return i=B(i),i?i+":":""}function dl(i){return i}const nn="memory",on=()=>{const i=new Map;return{name:nn,getInstance:()=>i,hasItem(e){return i.has(e)},getItem(e){return i.get(e)??null},getItemRaw(e){return i.get(e)??null},setItem(e,t){i.set(e,t)},setItemRaw(e,t){i.set(e,t)},removeItem(e){i.delete(e)},getKeys(){return[...i.keys()]},clear(){i.clear()},dispose(){i.clear()}}};function an(i={}){const e={mounts:{"":i.driver||on()},mountpoints:[""],watching:!1,watchListeners:[],unwatch:{}},t=c=>{for(const d of e.mountpoints)if(c.startsWith(d))return{base:d,relativeKey:c.slice(d.length),driver:e.mounts[d]};return{base:"",relativeKey:c,driver:e.mounts[""]}},r=(c,d)=>e.mountpoints.filter(p=>p.startsWith(c)||d&&c.startsWith(p)).map(p=>({relativeBase:c.length>p.length?c.slice(p.length):void 0,mountpoint:p,driver:e.mounts[p]})),s=(c,d)=>{if(e.watching){d=B(d);for(const p of e.watchListeners)p(c,d)}},n=async()=>{if(!e.watching){e.watching=!0;for(const c in e.mounts)e.unwatch[c]=await ui(e.mounts[c],s,c)}},o=async()=>{if(e.watching){for(const c in e.unwatch)await e.unwatch[c]();e.unwatch={},e.watching=!1}},h=(c,d,p)=>{const m=new Map,b=y=>{let _=m.get(y.base);return _||(_={driver:y.driver,base:y.base,items:[]},m.set(y.base,_)),_};for(const y of c){const _=typeof y=="string",S=B(_?y:y.key),I=_?void 0:y.value,D=_||!y.options?d:{...d,...y.options},L=t(S);b(L).items.push({key:S,value:I,relativeKey:L.relativeKey,options:D})}return Promise.all([...m.values()].map(y=>p(y))).then(y=>y.flat())},u={hasItem(c,d={}){c=B(c);const{relativeKey:p,driver:m}=t(c);return N(m.hasItem,p,d)},getItem(c,d={}){c=B(c);const{relativeKey:p,driver:m}=t(c);return N(m.getItem,p,d).then(b=>Je(b))},getItems(c,d={}){return h(c,d,p=>p.driver.getItems?N(p.driver.getItems,p.items.map(m=>({key:m.relativeKey,options:m.options})),d).then(m=>m.map(b=>({key:sn(p.base,b.key),value:Je(b.value)}))):Promise.all(p.items.map(m=>N(p.driver.getItem,m.relativeKey,m.options).then(b=>({key:m.key,value:Je(b)})))))},getItemRaw(c,d={}){c=B(c);const{relativeKey:p,driver:m}=t(c);return m.getItemRaw?N(m.getItemRaw,p,d):N(m.getItem,p,d).then(b=>en(b))},async setItem(c,d,p={}){if(d===void 0)return u.removeItem(c);c=B(c);const{relativeKey:m,driver:b}=t(c);b.setItem&&(await N(b.setItem,m,Ze(d),p),b.watch||s("update",c))},async setItems(c,d){await h(c,d,async p=>{if(p.driver.setItems)return N(p.driver.setItems,p.items.map(m=>({key:m.relativeKey,value:Ze(m.value),options:m.options})),d);p.driver.setItem&&await Promise.all(p.items.map(m=>N(p.driver.setItem,m.relativeKey,Ze(m.value),m.options)))})},async setItemRaw(c,d,p={}){if(d===void 0)return u.removeItem(c,p);c=B(c);const{relativeKey:m,driver:b}=t(c);if(b.setItemRaw)await N(b.setItemRaw,m,d,p);else if(b.setItem)await N(b.setItem,m,Qs(d),p);else return;b.watch||s("update",c)},async removeItem(c,d={}){typeof d=="boolean"&&(d={removeMeta:d}),c=B(c);const{relativeKey:p,driver:m}=t(c);m.removeItem&&(await N(m.removeItem,p,d),(d.removeMeta||d.removeMata)&&await N(m.removeItem,p+"$",d),m.watch||s("remove",c))},async getMeta(c,d={}){typeof d=="boolean"&&(d={nativeOnly:d}),c=B(c);const{relativeKey:p,driver:m}=t(c),b=Object.create(null);if(m.getMeta&&Object.assign(b,await N(m.getMeta,p,d)),!d.nativeOnly){const y=await N(m.getItem,p+"$",d).then(_=>Je(_));y&&typeof y=="object"&&(typeof y.atime=="string"&&(y.atime=new Date(y.atime)),typeof y.mtime=="string"&&(y.mtime=new Date(y.mtime)),Object.assign(b,y))}return b},setMeta(c,d,p={}){return this.setItem(c+"$",d,p)},removeMeta(c,d={}){return this.removeItem(c+"$",d)},async getKeys(c,d={}){c=Qe(c);const p=r(c,!0);let m=[];const b=[];for(const y of p){const _=await N(y.driver.getKeys,y.relativeBase,d);for(const S of _){const I=y.mountpoint+B(S);m.some(D=>I.startsWith(D))||b.push(I)}m=[y.mountpoint,...m.filter(S=>!S.startsWith(y.mountpoint))]}return c?b.filter(y=>y.startsWith(c)&&y[y.length-1]!=="$"):b.filter(y=>y[y.length-1]!=="$")},async clear(c,d={}){c=Qe(c),await Promise.all(r(c,!1).map(async p=>{if(p.driver.clear)return N(p.driver.clear,p.relativeBase,d);if(p.driver.removeItem){const m=await p.driver.getKeys(p.relativeBase||"",d);return Promise.all(m.map(b=>p.driver.removeItem(b,d)))}}))},async dispose(){await Promise.all(Object.values(e.mounts).map(c=>di(c)))},async watch(c){return await n(),e.watchListeners.push(c),async()=>{e.watchListeners=e.watchListeners.filter(d=>d!==c),e.watchListeners.length===0&&await o()}},async unwatch(){e.watchListeners=[],await o()},mount(c,d){if(c=Qe(c),c&&e.mounts[c])throw new Error(`already mounted at ${c}`);return c&&(e.mountpoints.push(c),e.mountpoints.sort((p,m)=>m.length-p.length)),e.mounts[c]=d,e.watching&&Promise.resolve(ui(d,s,c)).then(p=>{e.unwatch[c]=p}).catch(console.error),u},async unmount(c,d=!0){c=Qe(c),!(!c||!e.mounts[c])&&(e.watching&&c in e.unwatch&&(e.unwatch[c]?.(),delete e.unwatch[c]),d&&await di(e.mounts[c]),e.mountpoints=e.mountpoints.filter(p=>p!==c),delete e.mounts[c])},getMount(c=""){c=B(c)+":";const d=t(c);return{driver:d.driver,base:d.base}},getMounts(c="",d={}){return c=B(c),r(c,d.parents).map(m=>({driver:m.driver,base:m.mountpoint}))},keys:(c,d={})=>u.getKeys(c,d),get:(c,d={})=>u.getItem(c,d),set:(c,d,p={})=>u.setItem(c,d,p),has:(c,d={})=>u.hasItem(c,d),del:(c,d={})=>u.removeItem(c,d),remove:(c,d={})=>u.removeItem(c,d)};return u}function ui(i,e,t){return i.watch?i.watch((r,s)=>e(r,t+s)):()=>{}}async function di(i){typeof i.dispose=="function"&&await N(i.dispose)}function fe(i){return new Promise((e,t)=>{i.oncomplete=i.onsuccess=()=>e(i.result),i.onabort=i.onerror=()=>t(i.error)})}function gi(i,e){const t=indexedDB.open(i);t.onupgradeneeded=()=>t.result.createObjectStore(e);const r=fe(t);return(s,n)=>r.then(o=>n(o.transaction(e,s).objectStore(e)))}let wt;function Le(){return wt||(wt=gi("keyval-store","keyval")),wt}function Dt(i,e=Le()){return e("readonly",t=>fe(t.get(i)))}function pi(i,e,t=Le()){return t("readwrite",r=>(r.put(e,i),fe(r.transaction)))}function cn(i,e=Le()){return e("readwrite",t=>(t.delete(i),fe(t.transaction)))}function hn(i=Le()){return i("readwrite",e=>(e.clear(),fe(e.transaction)))}function ln(i,e){return i.openCursor().onsuccess=function(){this.result&&(e(this.result),this.result.continue())},fe(i.transaction)}function un(i=Le()){return i("readonly",e=>{if(e.getAllKeys)return fe(e.getAllKeys());const t=[];return ln(e,r=>t.push(r.key)).then(()=>t)})}const dn=i=>JSON.stringify(i,(e,t)=>typeof t=="bigint"?t.toString()+"n":t),gn=i=>{const e=new RegExp('(?<!")(?<=:)\\b(\\d{17,}|(?:[9](?:[1-9]07199254740991|0[1-9]7199254740991|00[8-9]199254740991|007[2-9]99254740991|007199[3-9]54740991|0071992[6-9]4740991|00719925[5-9]740991|007199254[8-9]40991|0071992547[5-9]0991|00719925474[1-9]991|00719925474099[2-9])))(?=[,\\}\\]]|$)',"g"),t=i.replace(e,r=>`"${r}n"`);return JSON.parse(t,(r,s)=>typeof s=="string"&&s.match(/^\d+n$/)?BigInt(s.substring(0,s.length-1)):s)};function et(i){if(typeof i!="string")throw new Error(`Cannot safe json parse value of type ${typeof i}`);try{return gn(i)}catch(e){return console.error("safeJsonParse error:",e),i}}function Ne(i){return typeof i=="string"?i:dn(i)||""}const pn="idb-keyval";var fn=(i={})=>{const e=i.base&&i.base.length>0?`${i.base}:`:"",t=s=>e+s;let r;return i.dbName&&i.storeName&&(r=gi(i.dbName,i.storeName)),{name:pn,options:i,async hasItem(s){return await Dt(t(s),r)!==void 0},async getItem(s){var n;return(n=await Dt(t(s),r))!=null?n:null},async getItemRaw(s){var n;return(n=await Dt(t(s),r))!=null?n:null},setItem(s,n){return pi(t(s),n,r)},setItemRaw(s,n){return pi(t(s),n,r)},removeItem(s){return cn(t(s),r)},getKeys(){return un(r)},clear(){return hn(r)}}};const yn="WALLET_CONNECT_V2_INDEXED_DB",mn="keyvaluestorage";class vn{constructor(){this.indexedDb=an({driver:fn({dbName:yn,storeName:mn})})}async getKeys(){return this.indexedDb.getKeys()}async getEntries(){return(await this.indexedDb.getItems(await this.indexedDb.getKeys())).map(e=>[e.key,e.value])}async getItem(e){const t=await this.indexedDb.getItem(e);if(t!==null)return t}async setItem(e,t){await this.indexedDb.setItem(e,Ne(t))}async removeItem(e){await this.indexedDb.removeItem(e)}}var It=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},tt={exports:{}};(function(){let i;function e(){}i=e,i.prototype.getItem=function(t){return this.hasOwnProperty(t)?String(this[t]):null},i.prototype.setItem=function(t,r){this[t]=String(r)},i.prototype.removeItem=function(t){delete this[t]},i.prototype.clear=function(){const t=this;Object.keys(t).forEach(function(r){t[r]=void 0,delete t[r]})},i.prototype.key=function(t){return t=t||0,Object.keys(this)[t]},i.prototype.__defineGetter__("length",function(){return Object.keys(this).length}),typeof It<"u"&&It.localStorage?tt.exports=It.localStorage:typeof window<"u"&&window.localStorage?tt.exports=window.localStorage:tt.exports=new e})();function bn(i){var e;return[i[0],et((e=i[1])!=null?e:"")]}class En{constructor(){this.localStorage=tt.exports}async getKeys(){return Object.keys(this.localStorage)}async getEntries(){return Object.entries(this.localStorage).map(bn)}async getItem(e){const t=this.localStorage.getItem(e);if(t!==null)return et(t)}async setItem(e,t){this.localStorage.setItem(e,Ne(t))}async removeItem(e){this.localStorage.removeItem(e)}}const _n="wc_storage_version",fi=1,wn=async(i,e,t)=>{const r=_n,s=await e.getItem(r);if(s&&s>=fi){t(e);return}const n=await i.getKeys();if(!n.length){t(e);return}const o=[];for(;n.length;){const h=n.shift();if(!h)continue;const u=h.toLowerCase();if(u.includes("wc@")||u.includes("walletconnect")||u.includes("wc_")||u.includes("wallet_connect")){const c=await i.getItem(h);await e.setItem(h,c),o.push(h)}}await e.setItem(r,fi),t(e),Dn(i,o)},Dn=async(i,e)=>{e.length&&e.forEach(async t=>{await i.removeItem(t)})};class In{constructor(){this.initialized=!1,this.setInitialized=t=>{this.storage=t,this.initialized=!0};const e=new En;this.storage=e;try{const t=new vn;wn(e,t,this.setInitialized)}catch{this.initialized=!0}}async getKeys(){return await this.initialize(),this.storage.getKeys()}async getEntries(){return await this.initialize(),this.storage.getEntries()}async getItem(e){return await this.initialize(),this.storage.getItem(e)}async setItem(e,t){return await this.initialize(),this.storage.setItem(e,t)}async removeItem(e){return await this.initialize(),this.storage.removeItem(e)}async initialize(){this.initialized||await new Promise(e=>{const t=setInterval(()=>{this.initialized&&(clearInterval(t),e())},20)})}}function Tn(i){try{return JSON.stringify(i)}catch{return'"[Circular]"'}}var Sn=Rn;function Rn(i,e,t){var r=t&&t.stringify||Tn,s=1;if(typeof i=="object"&&i!==null){var n=e.length+s;if(n===1)return i;var o=new Array(n);o[0]=r(i);for(var h=1;h<n;h++)o[h]=r(e[h]);return o.join(" ")}if(typeof i!="string")return i;var u=e.length;if(u===0)return i;for(var c="",d=1-s,p=-1,m=i&&i.length||0,b=0;b<m;){if(i.charCodeAt(b)===37&&b+1<m){switch(p=p>-1?p:0,i.charCodeAt(b+1)){case 100:case 102:if(d>=u||e[d]==null)break;p<b&&(c+=i.slice(p,b)),c+=Number(e[d]),p=b+2,b++;break;case 105:if(d>=u||e[d]==null)break;p<b&&(c+=i.slice(p,b)),c+=Math.floor(Number(e[d])),p=b+2,b++;break;case 79:case 111:case 106:if(d>=u||e[d]===void 0)break;p<b&&(c+=i.slice(p,b));var y=typeof e[d];if(y==="string"){c+="'"+e[d]+"'",p=b+2,b++;break}if(y==="function"){c+=e[d].name||"<anonymous>",p=b+2,b++;break}c+=r(e[d]),p=b+2,b++;break;case 115:if(d>=u)break;p<b&&(c+=i.slice(p,b)),c+=String(e[d]),p=b+2,b++;break;case 37:p<b&&(c+=i.slice(p,b)),c+="%",p=b+2,b++,d--;break}++d}++b}return p===-1?i:(p<m&&(c+=i.slice(p)),c)}const yi=Sn;var ue=se;const xe=jn().console||{},On={mapHttpRequest:rt,mapHttpResponse:rt,wrapRequestSerializer:St,wrapResponseSerializer:St,wrapErrorSerializer:St,req:rt,res:rt,err:Nn};function Cn(i,e){return Array.isArray(i)?i.filter(function(r){return r!=="!stdSerializers.err"}):i===!0?Object.keys(e):!1}function se(i){i=i||{},i.browser=i.browser||{};const e=i.browser.transmit;if(e&&typeof e.send!="function")throw Error("pino: transmit option must have a send function");const t=i.browser.write||xe;i.browser.write&&(i.browser.asObject=!0);const r=i.serializers||{},s=Cn(i.browser.serialize,r);let n=i.browser.serialize;Array.isArray(i.browser.serialize)&&i.browser.serialize.indexOf("!stdSerializers.err")>-1&&(n=!1);const o=["error","fatal","warn","info","debug","trace"];typeof t=="function"&&(t.error=t.fatal=t.warn=t.info=t.debug=t.trace=t),i.enabled===!1&&(i.level="silent");const h=i.level||"info",u=Object.create(t);u.log||(u.log=$e),Object.defineProperty(u,"levelVal",{get:d}),Object.defineProperty(u,"level",{get:p,set:m});const c={transmit:e,serialize:s,asObject:i.browser.asObject,levels:o,timestamp:xn(i)};u.levels=se.levels,u.level=h,u.setMaxListeners=u.getMaxListeners=u.emit=u.addListener=u.on=u.prependListener=u.once=u.prependOnceListener=u.removeListener=u.removeAllListeners=u.listeners=u.listenerCount=u.eventNames=u.write=u.flush=$e,u.serializers=r,u._serialize=s,u._stdErrSerialize=n,u.child=b,e&&(u._logEvent=Tt());function d(){return this.level==="silent"?1/0:this.levels.values[this.level]}function p(){return this._level}function m(y){if(y!=="silent"&&!this.levels.values[y])throw Error("unknown level "+y);this._level=y,Ie(c,u,"error","log"),Ie(c,u,"fatal","error"),Ie(c,u,"warn","error"),Ie(c,u,"info","log"),Ie(c,u,"debug","log"),Ie(c,u,"trace","log")}function b(y,_){if(!y)throw new Error("missing bindings for child Pino");_=_||{},s&&y.serializers&&(_.serializers=y.serializers);const S=_.serializers;if(s&&S){var I=Object.assign({},r,S),D=i.browser.serialize===!0?Object.keys(I):s;delete y.serializers,it([y],D,I,this._stdErrSerialize)}function L(R){this._childLevel=(R._childLevel|0)+1,this.error=Te(R,y,"error"),this.fatal=Te(R,y,"fatal"),this.warn=Te(R,y,"warn"),this.info=Te(R,y,"info"),this.debug=Te(R,y,"debug"),this.trace=Te(R,y,"trace"),I&&(this.serializers=I,this._serialize=D),e&&(this._logEvent=Tt([].concat(R._logEvent.bindings,y)))}return L.prototype=this,new L(this)}return u}se.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}},se.stdSerializers=On,se.stdTimeFunctions=Object.assign({},{nullTime:mi,epochTime:vi,unixTime:$n,isoTime:zn});function Ie(i,e,t,r){const s=Object.getPrototypeOf(e);e[t]=e.levelVal>e.levels.values[t]?$e:s[t]?s[t]:xe[t]||xe[r]||$e,Pn(i,e,t)}function Pn(i,e,t){!i.transmit&&e[t]===$e||(e[t]=function(r){return function(){const n=i.timestamp(),o=new Array(arguments.length),h=Object.getPrototypeOf&&Object.getPrototypeOf(this)===xe?xe:this;for(var u=0;u<o.length;u++)o[u]=arguments[u];if(i.serialize&&!i.asObject&&it(o,this._serialize,this.serializers,this._stdErrSerialize),i.asObject?r.call(h,An(this,t,o,n)):r.apply(h,o),i.transmit){const c=i.transmit.level||e.level,d=se.levels.values[c],p=se.levels.values[t];if(p<d)return;Ln(this,{ts:n,methodLevel:t,methodValue:p,transmitLevel:c,transmitValue:se.levels.values[i.transmit.level||e.level],send:i.transmit.send,val:e.levelVal},o)}}}(e[t]))}function An(i,e,t,r){i._serialize&&it(t,i._serialize,i.serializers,i._stdErrSerialize);const s=t.slice();let n=s[0];const o={};r&&(o.time=r),o.level=se.levels.values[e];let h=(i._childLevel|0)+1;if(h<1&&(h=1),n!==null&&typeof n=="object"){for(;h--&&typeof s[0]=="object";)Object.assign(o,s.shift());n=s.length?yi(s.shift(),s):void 0}else typeof n=="string"&&(n=yi(s.shift(),s));return n!==void 0&&(o.msg=n),o}function it(i,e,t,r){for(const s in i)if(r&&i[s]instanceof Error)i[s]=se.stdSerializers.err(i[s]);else if(typeof i[s]=="object"&&!Array.isArray(i[s]))for(const n in i[s])e&&e.indexOf(n)>-1&&n in t&&(i[s][n]=t[n](i[s][n]))}function Te(i,e,t){return function(){const r=new Array(1+arguments.length);r[0]=e;for(var s=1;s<r.length;s++)r[s]=arguments[s-1];return i[t].apply(this,r)}}function Ln(i,e,t){const r=e.send,s=e.ts,n=e.methodLevel,o=e.methodValue,h=e.val,u=i._logEvent.bindings;it(t,i._serialize||Object.keys(i.serializers),i.serializers,i._stdErrSerialize===void 0?!0:i._stdErrSerialize),i._logEvent.ts=s,i._logEvent.messages=t.filter(function(c){return u.indexOf(c)===-1}),i._logEvent.level.label=n,i._logEvent.level.value=o,r(n,i._logEvent,h),i._logEvent=Tt(u)}function Tt(i){return{ts:0,messages:[],bindings:i||[],level:{label:"",value:0}}}function Nn(i){const e={type:i.constructor.name,msg:i.message,stack:i.stack};for(const t in i)e[t]===void 0&&(e[t]=i[t]);return e}function xn(i){return typeof i.timestamp=="function"?i.timestamp:i.timestamp===!1?mi:vi}function rt(){return{}}function St(i){return i}function $e(){}function mi(){return!1}function vi(){return Date.now()}function $n(){return Math.round(Date.now()/1e3)}function zn(){return new Date(Date.now()).toISOString()}function jn(){function i(e){return typeof e<"u"&&e}try{return typeof globalThis<"u"||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch{return i(self)||i(window)||i(this)||{}}}const Un={level:"info"},ze="custom_context",Rt=1e3*1024;class Mn{constructor(e){this.nodeValue=e,this.sizeInBytes=new TextEncoder().encode(this.nodeValue).length,this.next=null}get value(){return this.nodeValue}get size(){return this.sizeInBytes}}class bi{constructor(e){this.head=null,this.tail=null,this.lengthInNodes=0,this.maxSizeInBytes=e,this.sizeInBytes=0}append(e){const t=new Mn(e);if(t.size>this.maxSizeInBytes)throw new Error(`[LinkedList] Value too big to insert into list: ${e} with size ${t.size}`);for(;this.size+t.size>this.maxSizeInBytes;)this.shift();this.head?(this.tail&&(this.tail.next=t),this.tail=t):(this.head=t,this.tail=t),this.lengthInNodes++,this.sizeInBytes+=t.size}shift(){if(!this.head)return;const e=this.head;this.head=this.head.next,this.head||(this.tail=null),this.lengthInNodes--,this.sizeInBytes-=e.size}toArray(){const e=[];let t=this.head;for(;t!==null;)e.push(t.value),t=t.next;return e}get length(){return this.lengthInNodes}get size(){return this.sizeInBytes}toOrderedArray(){return Array.from(this)}[Symbol.iterator](){let e=this.head;return{next:()=>{if(!e)return{done:!0,value:null};const t=e.value;return e=e.next,{done:!1,value:t}}}}}class Ei{constructor(e,t=Rt){this.level=e??"error",this.levelValue=ue.levels.values[this.level],this.MAX_LOG_SIZE_IN_BYTES=t,this.logs=new bi(this.MAX_LOG_SIZE_IN_BYTES)}forwardToConsole(e,t){t===ue.levels.values.error?console.error(e):t===ue.levels.values.warn?console.warn(e):t===ue.levels.values.debug?console.debug(e):t===ue.levels.values.trace?console.trace(e):console.log(e)}appendToLogs(e){this.logs.append(Ne({timestamp:new Date().toISOString(),log:e}));const t=typeof e=="string"?JSON.parse(e).level:e.level;t>=this.levelValue&&this.forwardToConsole(e,t)}getLogs(){return this.logs}clearLogs(){this.logs=new bi(this.MAX_LOG_SIZE_IN_BYTES)}getLogArray(){return Array.from(this.logs)}logsToBlob(e){const t=this.getLogArray();return t.push(Ne({extraMetadata:e})),new Blob(t,{type:"application/json"})}}class Bn{constructor(e,t=Rt){this.baseChunkLogger=new Ei(e,t)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}downloadLogsBlobInBrowser(e){const t=URL.createObjectURL(this.logsToBlob(e)),r=document.createElement("a");r.href=t,r.download=`walletconnect-logs-${new Date().toISOString()}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t)}}class Fn{constructor(e,t=Rt){this.baseChunkLogger=new Ei(e,t)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}}var Kn=Object.defineProperty,Vn=Object.defineProperties,kn=Object.getOwnPropertyDescriptors,_i=Object.getOwnPropertySymbols,Gn=Object.prototype.hasOwnProperty,qn=Object.prototype.propertyIsEnumerable,wi=(i,e,t)=>e in i?Kn(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,st=(i,e)=>{for(var t in e||(e={}))Gn.call(e,t)&&wi(i,t,e[t]);if(_i)for(var t of _i(e))qn.call(e,t)&&wi(i,t,e[t]);return i},nt=(i,e)=>Vn(i,kn(e));function Di(i){return nt(st({},i),{level:i?.level||Un.level})}function Hn(i,e=ze){return i[e]||""}function Yn(i,e,t=ze){return i[t]=e,i}function k(i,e=ze){let t="";return typeof i.bindings>"u"?t=Hn(i,e):t=i.bindings().context||"",t}function Xn(i,e,t=ze){const r=k(i,t);return r.trim()?`${r}/${e}`:e}function F(i,e,t=ze){const r=Xn(i,e,t),s=i.child({context:r});return Yn(s,r,t)}function Wn(i){var e,t;const r=new Bn((e=i.opts)==null?void 0:e.level,i.maxSizeInBytes);return{logger:ue(nt(st({},i.opts),{level:"trace",browser:nt(st({},(t=i.opts)==null?void 0:t.browser),{write:s=>r.write(s)})})),chunkLoggerController:r}}function Jn(i){var e;const t=new Fn((e=i.opts)==null?void 0:e.level,i.maxSizeInBytes);return{logger:ue(nt(st({},i.opts),{level:"trace"})),chunkLoggerController:t}}function Zn(i){return typeof i.loggerOverride<"u"&&typeof i.loggerOverride!="string"?{logger:i.loggerOverride,chunkLoggerController:null}:typeof window<"u"?Wn(i):Jn(i)}class Se{}class Qn extends Se{constructor(e){super(),this.opts=e,this.protocol="wc",this.version=2}}class eo extends Se{constructor(e,t){super(),this.core=e,this.logger=t,this.records=new Map}}class to{constructor(e,t){this.logger=e,this.core=t}}class io extends Se{constructor(e,t){super(),this.relayer=e,this.logger=t}}class ro extends Se{constructor(e){super()}}class so{constructor(e,t,r,s){this.core=e,this.logger=t,this.name=r}}class no extends Se{constructor(e,t){super(),this.relayer=e,this.logger=t}}class oo extends Se{constructor(e,t){super(),this.core=e,this.logger=t}}class ao{constructor(e,t,r){this.core=e,this.logger=t,this.store=r}}class co{constructor(e,t){this.projectId=e,this.logger=t}}class ho{constructor(e,t,r){this.core=e,this.logger=t,this.telemetryEnabled=r}}const Ot="wc",Ct=2,je="core",Q=`${Ot}@2:${je}:`,Ii={name:je,logger:"error"},Ti={database:":memory:"},Si=1e3,ye=1,Pt=5,At=30,Ri=60,Lt=300,lo=21600,Re=86400,ot=2592e3;function U(i){return i*Si}function Oi(i){return Math.floor(i/Si)}class uo{constructor(){this.timestamps=new Map}start(e){if(this.timestamps.has(e))throw new Error(`Watch already started for label: ${e}`);this.timestamps.set(e,{started:Date.now()})}stop(e){const t=this.get(e);if(typeof t.elapsed<"u")throw new Error(`Watch already stopped for label: ${e}`);const r=Date.now()-t.started;this.timestamps.set(e,{started:t.started,elapsed:r})}get(e){const t=this.timestamps.get(e);if(typeof t>"u")throw new Error(`No timestamp found for label: ${e}`);return t}elapsed(e){const t=this.get(e);return t.elapsed||Date.now()-t.started}}const Ci="crypto",Nt="client_ed25519_seed",Pi=Re,Ai="keychain",Li="0.3",Ni="messages",xi="0.3",xt=lo,$i="publisher",zi="irn",ji="error",$t="wss://relay.walletconnect.org",Ui="relayer",$={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Mi="_subscription",G={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},Bi=.1,go={database:":memory:"},at="2.17.3",po=1e4,me={link_mode:"link_mode",relay:"relay"},Fi="0.3",Ki="WALLETCONNECT_CLIENT_ID",zt="WALLETCONNECT_LINK_MODE_APPS",K={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},fo=ot,Vi="subscription",ki="0.3",Gi=Pt*1e3,qi="pairing",Hi="0.3",yo=ot,Oe={wc_pairingDelete:{req:{ttl:Re,prompt:!1,tag:1e3},res:{ttl:Re,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:At,prompt:!1,tag:1002},res:{ttl:At,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:Re,prompt:!1,tag:0},res:{ttl:Re,prompt:!1,tag:0}}},Ce={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},X={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Yi="history",Xi="0.3",Wi="expirer",W={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ji="0.3",mo=Re,Zi="verify-api",vo="https://verify.walletconnect.com",Qi="https://verify.walletconnect.org",Ue=Qi,er=`${Ue}/v3`,tr=[vo,Qi],ir="echo",rr="https://echo.walletconnect.com",bo="event-client",ne={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},ae={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},Eo={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},_o={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},wo={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},Do={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},sr=.1,nr="event-client",or=86400,ar="https://pulse.walletconnect.org/batch";function Io(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(i):new Uint8Array(i)}function To(i,e){if(i.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var s=0;s<i.length;s++){var n=i.charAt(s),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=s}var h=i.length,u=i.charAt(0),c=Math.log(h)/Math.log(256),d=Math.log(256)/Math.log(h);function p(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var _=0,S=0,I=0,D=y.length;I!==D&&y[I]===0;)I++,_++;for(var L=(D-I)*d+1>>>0,R=new Uint8Array(L);I!==D;){for(var q=y[I],H=0,V=L-1;(q!==0||H<S)&&V!==-1;V--,H++)q+=256*R[V]>>>0,R[V]=q%h>>>0,q=q/h>>>0;if(q!==0)throw new Error("Non-zero carry");S=H,I++}for(var ee=L-S;ee!==L&&R[ee]===0;)ee++;for(var Pe=u.repeat(_);ee<L;++ee)Pe+=i.charAt(R[ee]);return Pe}function m(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var _=0;if(y[_]!==" "){for(var S=0,I=0;y[_]===u;)S++,_++;for(var D=(y.length-_)*c+1>>>0,L=new Uint8Array(D);y[_];){var R=t[y.charCodeAt(_)];if(R===255)return;for(var q=0,H=D-1;(R!==0||q<I)&&H!==-1;H--,q++)R+=h*L[H]>>>0,L[H]=R%256>>>0,R=R/256>>>0;if(R!==0)throw new Error("Non-zero carry");I=q,_++}if(y[_]!==" "){for(var V=D-I;V!==D&&L[V]===0;)V++;for(var ee=new Uint8Array(S+(D-V)),Pe=S;V!==D;)ee[Pe++]=L[V++];return ee}}}function b(y){var _=m(y);if(_)return _;throw new Error(`Non-${e} character`)}return{encode:p,decodeUnsafe:m,decode:b}}var So=To,Ro=So;const cr=i=>{if(i instanceof Uint8Array&&i.constructor.name==="Uint8Array")return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(ArrayBuffer.isView(i))return new Uint8Array(i.buffer,i.byteOffset,i.byteLength);throw new Error("Unknown type, must be binary type")},Oo=i=>new TextEncoder().encode(i),Co=i=>new TextDecoder().decode(i);class Po{constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Ao{constructor(e,t,r){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return hr(this,e)}}class Lo{constructor(e){this.decoders=e}or(e){return hr(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const hr=(i,e)=>new Lo({...i.decoders||{[i.prefix]:i},...e.decoders||{[e.prefix]:e}});class No{constructor(e,t,r,s){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=s,this.encoder=new Po(e,t,r),this.decoder=new Ao(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const ct=({name:i,prefix:e,encode:t,decode:r})=>new No(i,e,t,r),Me=({prefix:i,name:e,alphabet:t})=>{const{encode:r,decode:s}=Ro(t,e);return ct({prefix:i,name:e,encode:r,decode:n=>cr(s(n))})},xo=(i,e,t,r)=>{const s={};for(let d=0;d<e.length;++d)s[e[d]]=d;let n=i.length;for(;i[n-1]==="=";)--n;const o=new Uint8Array(n*t/8|0);let h=0,u=0,c=0;for(let d=0;d<n;++d){const p=s[i[d]];if(p===void 0)throw new SyntaxError(`Non-${r} character`);u=u<<t|p,h+=t,h>=8&&(h-=8,o[c++]=255&u>>h)}if(h>=t||255&u<<8-h)throw new SyntaxError("Unexpected end of data");return o},$o=(i,e,t)=>{const r=e[e.length-1]==="=",s=(1<<t)-1;let n="",o=0,h=0;for(let u=0;u<i.length;++u)for(h=h<<8|i[u],o+=8;o>t;)o-=t,n+=e[s&h>>o];if(o&&(n+=e[s&h<<t-o]),r)for(;n.length*t&7;)n+="=";return n},z=({name:i,prefix:e,bitsPerChar:t,alphabet:r})=>ct({prefix:e,name:i,encode(s){return $o(s,r,t)},decode(s){return xo(s,r,t,i)}}),zo=ct({prefix:"\0",name:"identity",encode:i=>Co(i),decode:i=>Oo(i)});var jo=Object.freeze({__proto__:null,identity:zo});const Uo=z({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Mo=Object.freeze({__proto__:null,base2:Uo});const Bo=z({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Fo=Object.freeze({__proto__:null,base8:Bo});const Ko=Me({prefix:"9",name:"base10",alphabet:"0123456789"});var Vo=Object.freeze({__proto__:null,base10:Ko});const ko=z({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Go=z({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var qo=Object.freeze({__proto__:null,base16:ko,base16upper:Go});const Ho=z({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Yo=z({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Xo=z({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Wo=z({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Jo=z({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Zo=z({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Qo=z({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ea=z({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ta=z({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var ia=Object.freeze({__proto__:null,base32:Ho,base32upper:Yo,base32pad:Xo,base32padupper:Wo,base32hex:Jo,base32hexupper:Zo,base32hexpad:Qo,base32hexpadupper:ea,base32z:ta});const ra=Me({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),sa=Me({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var na=Object.freeze({__proto__:null,base36:ra,base36upper:sa});const oa=Me({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),aa=Me({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var ca=Object.freeze({__proto__:null,base58btc:oa,base58flickr:aa});const ha=z({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),la=z({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ua=z({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),da=z({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var ga=Object.freeze({__proto__:null,base64:ha,base64pad:la,base64url:ua,base64urlpad:da});const lr=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),pa=lr.reduce((i,e,t)=>(i[t]=e,i),[]),fa=lr.reduce((i,e,t)=>(i[e.codePointAt(0)]=t,i),[]);function ya(i){return i.reduce((e,t)=>(e+=pa[t],e),"")}function ma(i){const e=[];for(const t of i){const r=fa[t.codePointAt(0)];if(r===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(r)}return new Uint8Array(e)}const va=ct({prefix:"\u{1F680}",name:"base256emoji",encode:ya,decode:ma});var ba=Object.freeze({__proto__:null,base256emoji:va}),Ea=dr,ur=128,_a=127,wa=~_a,Da=Math.pow(2,31);function dr(i,e,t){e=e||[],t=t||0;for(var r=t;i>=Da;)e[t++]=i&255|ur,i/=128;for(;i&wa;)e[t++]=i&255|ur,i>>>=7;return e[t]=i|0,dr.bytes=t-r+1,e}var Ia=jt,Ta=128,gr=127;function jt(i,r){var t=0,r=r||0,s=0,n=r,o,h=i.length;do{if(n>=h)throw jt.bytes=0,new RangeError("Could not decode varint");o=i[n++],t+=s<28?(o&gr)<<s:(o&gr)*Math.pow(2,s),s+=7}while(o>=Ta);return jt.bytes=n-r,t}var Sa=Math.pow(2,7),Ra=Math.pow(2,14),Oa=Math.pow(2,21),Ca=Math.pow(2,28),Pa=Math.pow(2,35),Aa=Math.pow(2,42),La=Math.pow(2,49),Na=Math.pow(2,56),xa=Math.pow(2,63),$a=function(i){return i<Sa?1:i<Ra?2:i<Oa?3:i<Ca?4:i<Pa?5:i<Aa?6:i<La?7:i<Na?8:i<xa?9:10},za={encode:Ea,decode:Ia,encodingLength:$a},pr=za;const fr=(i,e,t=0)=>(pr.encode(i,e,t),e),yr=i=>pr.encodingLength(i),Ut=(i,e)=>{const t=e.byteLength,r=yr(i),s=r+yr(t),n=new Uint8Array(s+t);return fr(i,n,0),fr(t,n,r),n.set(e,s),new ja(i,t,e,n)};class ja{constructor(e,t,r,s){this.code=e,this.size=t,this.digest=r,this.bytes=s}}const mr=({name:i,code:e,encode:t})=>new Ua(i,e,t);class Ua{constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Ut(this.code,t):t.then(r=>Ut(this.code,r))}else throw Error("Unknown type, must be binary type")}}const vr=i=>async e=>new Uint8Array(await crypto.subtle.digest(i,e)),Ma=mr({name:"sha2-256",code:18,encode:vr("SHA-256")}),Ba=mr({name:"sha2-512",code:19,encode:vr("SHA-512")});var Fa=Object.freeze({__proto__:null,sha256:Ma,sha512:Ba});const br=0,Ka="identity",Er=cr;var Va=Object.freeze({__proto__:null,identity:{code:br,name:Ka,encode:Er,digest:i=>Ut(br,Er(i))}});new TextEncoder,new TextDecoder;const _r={...jo,...Mo,...Fo,...Vo,...qo,...ia,...na,...ca,...ga,...ba};({...Fa,...Va});function wr(i,e,t,r){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:r}}}const Dr=wr("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),Mt=wr("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);const e=Io(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),Ir={utf8:Dr,"utf-8":Dr,hex:_r.base16,latin1:Mt,ascii:Mt,binary:Mt,..._r};function ka(i,e="utf8"){const t=Ir[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i,"utf8"):t.decoder.decode(`${t.prefix}${i}`)}function Ga(i,e="utf8"){const t=Ir[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i.buffer,i.byteOffset,i.byteLength).toString("utf8"):t.encoder.encode(i).substring(1)}class Tr{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=Ai,this.version=Li,this.initialized=!1,this.storagePrefix=Q,this.init=async()=>{if(!this.initialized){const r=await this.getKeyChain();typeof r<"u"&&(this.keychain=r),this.initialized=!0}},this.has=r=>(this.isInitialized(),this.keychain.has(r)),this.set=async(r,s)=>{this.isInitialized(),this.keychain.set(r,s),await this.persist()},this.get=r=>{this.isInitialized();const s=this.keychain.get(r);if(typeof s>"u"){const{message:n}=g.getInternalError("NO_MATCHING_KEY",`${this.name}: ${r}`);throw new Error(n)}return s},this.del=async r=>{this.isInitialized(),this.keychain.delete(r),await this.persist()},this.core=e,this.logger=F(t,this.name)}get context(){return k(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,g.mapToObj(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?g.objToMap(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Sr{constructor(e,t,r){this.core=e,this.logger=t,this.name=Ci,this.randomSessionIdentifier=g.generateRandomBytes32(),this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=s=>(this.isInitialized(),this.keychain.has(s)),this.getClientId=async()=>{this.isInitialized();const s=await this.getClientSeed(),n=He.generateKeyPair(s);return He.encodeIss(n.publicKey)},this.generateKeyPair=()=>{this.isInitialized();const s=g.generateKeyPair();return this.setPrivateKey(s.publicKey,s.privateKey)},this.signJWT=async s=>{this.isInitialized();const n=await this.getClientSeed(),o=He.generateKeyPair(n),h=this.randomSessionIdentifier,u=Pi;return await He.signJWT(h,s,u,o)},this.generateSharedKey=(s,n,o)=>{this.isInitialized();const h=this.getPrivateKey(s),u=g.deriveSymKey(h,n);return this.setSymKey(u,o)},this.setSymKey=async(s,n)=>{this.isInitialized();const o=n||g.hashKey(s);return await this.keychain.set(o,s),o},this.deleteKeyPair=async s=>{this.isInitialized(),await this.keychain.del(s)},this.deleteSymKey=async s=>{this.isInitialized(),await this.keychain.del(s)},this.encode=async(s,n,o)=>{this.isInitialized();const h=g.validateEncoding(o),u=Ne(n);if(g.isTypeTwoEnvelope(h))return g.encodeTypeTwoEnvelope(u,o?.encoding);if(g.isTypeOneEnvelope(h)){const m=h.senderPublicKey,b=h.receiverPublicKey;s=await this.generateSharedKey(m,b)}const c=this.getSymKey(s),{type:d,senderPublicKey:p}=h;return g.encrypt({type:d,symKey:c,message:u,senderPublicKey:p,encoding:o?.encoding})},this.decode=async(s,n,o)=>{this.isInitialized();const h=g.validateDecoding(n,o);if(g.isTypeTwoEnvelope(h)){const u=g.decodeTypeTwoEnvelope(n,o?.encoding);return et(u)}if(g.isTypeOneEnvelope(h)){const u=h.receiverPublicKey,c=h.senderPublicKey;s=await this.generateSharedKey(u,c)}try{const u=this.getSymKey(s),c=g.decrypt({symKey:u,encoded:n,encoding:o?.encoding});return et(c)}catch(u){this.logger.error(`Failed to decode message from topic: '${s}', clientId: '${await this.getClientId()}'`),this.logger.error(u)}},this.getPayloadType=(s,n=g.BASE64)=>{const o=g.deserialize({encoded:s,encoding:n});return g.decodeTypeByte(o.type)},this.getPayloadSenderPublicKey=(s,n=g.BASE64)=>{const o=g.deserialize({encoded:s,encoding:n});return o.senderPublicKey?Ga(o.senderPublicKey,g.BASE16):void 0},this.core=e,this.logger=F(t,this.name),this.keychain=r||new Tr(this.core,this.logger)}get context(){return k(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(Nt)}catch{e=g.generateRandomBytes32(),await this.keychain.set(Nt,e)}return ka(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Rr extends to{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=Ni,this.version=xi,this.initialized=!1,this.storagePrefix=Q,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const r=await this.getRelayerMessages();typeof r<"u"&&(this.messages=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(r){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(r)}finally{this.initialized=!0}}},this.set=async(r,s)=>{this.isInitialized();const n=g.hashMessage(s);let o=this.messages.get(r);return typeof o>"u"&&(o={}),typeof o[n]<"u"||(o[n]=s,this.messages.set(r,o),await this.persist()),n},this.get=r=>{this.isInitialized();let s=this.messages.get(r);return typeof s>"u"&&(s={}),s},this.has=(r,s)=>{this.isInitialized();const n=this.get(r),o=g.hashMessage(s);return typeof n[o]<"u"},this.del=async r=>{this.isInitialized(),this.messages.delete(r),await this.persist()},this.logger=F(e,this.name),this.core=t}get context(){return k(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,g.mapToObj(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?g.objToMap(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}}class qa{}class Ha extends qa{constructor(){super()}}class Ya extends Ha{constructor(e){super()}}const Xa="PARSE_ERROR",Wa="INVALID_REQUEST",Ja="METHOD_NOT_FOUND",Za="INVALID_PARAMS",Or="INTERNAL_ERROR",Bt="SERVER_ERROR",Qa=[-32700,-32600,-32601,-32602,-32603],Be={[Xa]:{code:-32700,message:"Parse error"},[Wa]:{code:-32600,message:"Invalid Request"},[Ja]:{code:-32601,message:"Method not found"},[Za]:{code:-32602,message:"Invalid params"},[Or]:{code:-32603,message:"Internal error"},[Bt]:{code:-32e3,message:"Server error"}},Cr=Bt;function ec(i){return Qa.includes(i)}function Pr(i){return Object.keys(Be).includes(i)?Be[i]:Be[Cr]}function tc(i){return Object.values(Be).find(e=>e.code===i)||Be[Cr]}var ic=Object.defineProperty,rc=Object.defineProperties,sc=Object.getOwnPropertyDescriptors,Ar=Object.getOwnPropertySymbols,nc=Object.prototype.hasOwnProperty,oc=Object.prototype.propertyIsEnumerable,Lr=(i,e,t)=>e in i?ic(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ac=(i,e)=>{for(var t in e||(e={}))nc.call(e,t)&&Lr(i,t,e[t]);if(Ar)for(var t of Ar(e))oc.call(e,t)&&Lr(i,t,e[t]);return i},cc=(i,e)=>rc(i,sc(e));class Nr{constructor(e){this.i=1;const t=e===8?new Uint8Array(1):e===16?new Uint16Array(1):new Uint32Array(1);this.initialValue=crypto.getRandomValues(t)[0]}getNextValue(){return this.initialValue+this.i++}}const hc=new Nr(8),lc=new Nr(16);function uc(){const i=Date.now()*1e3,e=hc.getNextValue();return i+e}function Ft(){const i=BigInt(Date.now())*BigInt(1e6),e=BigInt(lc.getNextValue());return i+e}function Kt(i,e,t){return{id:t||uc(),jsonrpc:"2.0",method:i,params:e}}function xr(i,e){return{id:i,jsonrpc:"2.0",result:e}}function dc(i,e,t){return{id:i,jsonrpc:"2.0",error:gc(e,t)}}function gc(i,e){return typeof i>"u"?Pr(Or):(typeof i=="string"&&(i=cc(ac({},Pr(Bt)),{message:i})),typeof e<"u"&&(i.data=e),ec(i.code)&&(i=tc(i.code)),i)}function $r(i){return typeof i=="object"&&"id"in i&&"jsonrpc"in i&&i.jsonrpc==="2.0"}function zr(i){return $r(i)&&"method"in i}function Vt(i){return $r(i)&&(jr(i)||ht(i))}function jr(i){return"result"in i}function ht(i){return"error"in i}class pc extends Ya{constructor(e){super(e),this.events=new re.exports.EventEmitter,this.hasRegisteredEventListeners=!1,this.connection=this.setConnection(e),this.connection.connected&&this.registerEventListeners()}async connect(e=this.connection){await this.open(e)}async disconnect(){await this.close()}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async request(e,t){return this.requestStrict(Kt(e.method,e.params||[],e.id||Ft().toString()),t)}async requestStrict(e,t){return new Promise(async(r,s)=>{if(!this.connection.connected)try{await this.open()}catch(n){s(n)}this.events.on(`${e.id}`,n=>{ht(n)?s(n.error):r(n.result)});try{await this.connection.send(e,t)}catch(n){s(n)}})}setConnection(e=this.connection){return e}onPayload(e){this.events.emit("payload",e),Vt(e)?this.events.emit(`${e.id}`,e):this.events.emit("message",{type:e.method,data:e.params})}onClose(e){e&&e.code===3e3&&this.events.emit("error",new Error(`WebSocket connection closed abnormally with code: ${e.code} ${e.reason?`(${e.reason})`:""}`)),this.events.emit("disconnect")}async open(e=this.connection){this.connection===e&&this.connection.connected||(this.connection.connected&&this.close(),typeof e=="string"&&(await this.connection.open(e),e=this.connection),this.connection=this.setConnection(e),await this.connection.open(),this.registerEventListeners(),this.events.emit("connect"))}async close(){await this.connection.close()}registerEventListeners(){this.hasRegisteredEventListeners||(this.connection.on("payload",e=>this.onPayload(e)),this.connection.on("close",e=>this.onClose(e)),this.connection.on("error",e=>this.events.emit("error",e)),this.connection.on("register_error",e=>this.onClose()),this.hasRegisteredEventListeners=!0)}}var fc=Object.defineProperty,yc=Object.defineProperties,mc=Object.getOwnPropertyDescriptors,Ur=Object.getOwnPropertySymbols,vc=Object.prototype.hasOwnProperty,bc=Object.prototype.propertyIsEnumerable,Mr=(i,e,t)=>e in i?fc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Br=(i,e)=>{for(var t in e||(e={}))vc.call(e,t)&&Mr(i,t,e[t]);if(Ur)for(var t of Ur(e))bc.call(e,t)&&Mr(i,t,e[t]);return i},Fr=(i,e)=>yc(i,mc(e));class Ec extends io{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new re.exports.EventEmitter,this.name=$i,this.queue=new Map,this.publishTimeout=U(Ri),this.initialPublishTimeout=U(ye*15),this.needsTransportRestart=!1,this.publish=async(r,s,n)=>{var o;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:r,message:s,opts:n}});const h=n?.ttl||xt,u=g.getRelayProtocolName(n),c=n?.prompt||!1,d=n?.tag||0,p=n?.id||Ft().toString(),m={topic:r,message:s,opts:{ttl:h,relay:u,prompt:c,tag:d,id:p,attestation:n?.attestation}},b=`Failed to publish payload, please try again. id:${p} tag:${d}`;try{const y=new Promise(async _=>{const S=({id:D})=>{m.opts.id===D&&(this.removeRequestFromQueue(D),this.relayer.events.removeListener($.publish,S),_(m))};this.relayer.events.on($.publish,S);const I=g.createExpiringPromise(new Promise((D,L)=>{this.rpcPublish({topic:r,message:s,ttl:h,prompt:c,tag:d,id:p,attestation:n?.attestation}).then(D).catch(R=>{this.logger.warn(R,R?.message),L(R)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${p} tag:${d}`);try{await I,this.events.removeListener($.publish,S)}catch(D){this.queue.set(p,Fr(Br({},m),{attempt:1})),this.logger.warn(D,D?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:p,topic:r,message:s,opts:n}}),await g.createExpiringPromise(y,this.publishTimeout,b)}catch(y){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(y),(o=n?.internal)!=null&&o.throwOnFailedPublish)throw y}finally{this.queue.delete(p)}},this.on=(r,s)=>{this.events.on(r,s)},this.once=(r,s)=>{this.events.once(r,s)},this.off=(r,s)=>{this.events.off(r,s)},this.removeListener=(r,s)=>{this.events.removeListener(r,s)},this.relayer=e,this.logger=F(t,this.name),this.registerEventListeners()}get context(){return k(this.logger)}async rpcPublish(e){var t,r,s,n;const{topic:o,message:h,ttl:u=xt,prompt:c,tag:d,id:p,attestation:m}=e,b={method:g.getRelayProtocolApi(g.getRelayProtocolName().protocol).publish,params:{topic:o,message:h,ttl:u,prompt:c,tag:d,attestation:m},id:p};g.isUndefined((t=b.params)==null?void 0:t.prompt)&&((r=b.params)==null||delete r.prompt),g.isUndefined((s=b.params)==null?void 0:s.tag)&&((n=b.params)==null||delete n.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:b});const y=await this.relayer.request(b);return this.relayer.events.emit($.publish,e),this.logger.debug("Successfully Published Payload"),y}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,t)=>{const r=e.attempt+1;this.queue.set(t,Fr(Br({},e),{attempt:r}));const{topic:s,message:n,opts:o,attestation:h}=e;this.logger.warn({},`Publisher: queue->publishing: ${e.opts.id}, tag: ${e.opts.tag}, attempt: ${r}`),await this.rpcPublish({topic:s,message:n,ttl:o.ttl,prompt:o.prompt,tag:o.tag,id:o.id,attestation:h}),this.logger.warn({},`Publisher: queue->published: ${e.opts.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(ie.HEARTBEAT_EVENTS.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit($.connection_stalled);return}this.checkQueue()}),this.relayer.on($.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}}class _c{constructor(){this.map=new Map,this.set=(e,t)=>{const r=this.get(e);this.exists(e,t)||this.map.set(e,[...r,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const r=this.get(e);if(!this.exists(e,t))return;const s=r.filter(n=>n!==t);if(!s.length){this.map.delete(e);return}this.map.set(e,s)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var wc=Object.defineProperty,Dc=Object.defineProperties,Ic=Object.getOwnPropertyDescriptors,Kr=Object.getOwnPropertySymbols,Tc=Object.prototype.hasOwnProperty,Sc=Object.prototype.propertyIsEnumerable,Vr=(i,e,t)=>e in i?wc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Fe=(i,e)=>{for(var t in e||(e={}))Tc.call(e,t)&&Vr(i,t,e[t]);if(Kr)for(var t of Kr(e))Sc.call(e,t)&&Vr(i,t,e[t]);return i},kt=(i,e)=>Dc(i,Ic(e));class kr extends no{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new _c,this.events=new re.exports.EventEmitter,this.name=Vi,this.version=ki,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=Q,this.subscribeTimeout=U(Ri),this.initialSubscribeTimeout=U(ye*15),this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),this.clientId=await this.relayer.core.crypto.getClientId(),await this.restore()),this.initialized=!0},this.subscribe=async(r,s)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:r,opts:s}});try{const n=g.getRelayProtocolName(s),o={topic:r,relay:n,transportType:s?.transportType};this.pending.set(r,o);const h=await this.rpcSubscribe(r,n,s);return typeof h=="string"&&(this.onSubscribe(h,o),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:r,opts:s}})),h}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}},this.unsubscribe=async(r,s)=>{await this.restartToComplete(),this.isInitialized(),typeof s?.id<"u"?await this.unsubscribeById(r,s.id,s):await this.unsubscribeByTopic(r,s)},this.isSubscribed=async r=>{if(this.topics.includes(r))return!0;const s=`${this.pendingSubscriptionWatchLabel}_${r}`;return await new Promise((n,o)=>{const h=new uo;h.start(s);const u=setInterval(()=>{(!this.pending.has(r)&&this.topics.includes(r)||this.cached.some(c=>c.topic===r))&&(clearInterval(u),h.stop(s),n(!0)),h.elapsed(s)>=Gi&&(clearInterval(u),h.stop(s),o(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1)},this.on=(r,s)=>{this.events.on(r,s)},this.once=(r,s)=>{this.events.once(r,s)},this.off=(r,s)=>{this.events.off(r,s)},this.removeListener=(r,s)=>{this.events.removeListener(r,s)},this.start=async()=>{await this.onConnect()},this.stop=async()=>{await this.onDisconnect()},this.restart=async()=>{await this.restore(),await this.onRestart()},this.checkPending=async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;const r=[];this.pending.forEach(s=>{r.push(s)}),await this.batchSubscribe(r)},this.registerEventListeners=()=>{this.relayer.core.heartbeat.on(ie.HEARTBEAT_EVENTS.pulse,async()=>{await this.checkPending()}),this.events.on(K.created,async r=>{const s=K.created;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),await this.persist()}),this.events.on(K.deleted,async r=>{const s=K.deleted;this.logger.info(`Emitting ${s}`),this.logger.debug({type:"event",event:s,data:r}),await this.persist()})},this.relayer=e,this.logger=F(t,this.name),this.clientId=""}get context(){return k(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let r=!1;try{r=this.getSubscription(e).topic===t}catch{}return r}reset(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const r=this.topicMap.get(e);await Promise.all(r.map(async s=>await this.unsubscribeById(e,s,t)))}async unsubscribeById(e,t,r){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:r}});try{const s=g.getRelayProtocolName(r);await this.rpcUnsubscribe(e,t,s);const n=g.getSdkError("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:r}})}catch(s){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(s),s}}async rpcSubscribe(e,t,r){var s;r?.transportType===me.relay&&await this.restartToComplete();const n={method:g.getRelayProtocolApi(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});const o=(s=r?.internal)==null?void 0:s.throwOnFailedPublish;try{const h=this.getSubscriptionId(e);if(r?.transportType===me.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(n).catch(d=>this.logger.warn(d))},U(ye)),h;const u=new Promise(async d=>{const p=m=>{m.topic===e&&(this.events.removeListener(K.created,p),d(m.id))};this.events.on(K.created,p);try{const m=await g.createExpiringPromise(new Promise((b,y)=>{this.relayer.request(n).catch(_=>{this.logger.warn(_,_?.message),y(_)}).then(b)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(K.created,p),d(m)}catch{}}),c=await g.createExpiringPromise(u,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!c&&o)throw new Error(`Subscribing to ${e} failed, please try again`);return c?h:null}catch(h){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit($.connection_stalled),o)throw h}return null}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,r={method:g.getRelayProtocolApi(t.protocol).batchSubscribe,params:{topics:e.map(s=>s.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r});try{await await g.createExpiringPromise(new Promise(s=>{this.relayer.request(r).catch(n=>this.logger.warn(n)).then(s)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit($.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;const t=e[0].relay,r={method:g.getRelayProtocolApi(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r});let s;try{s=await await g.createExpiringPromise(new Promise((n,o)=>{this.relayer.request(r).catch(h=>{this.logger.warn(h),o(h)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit($.connection_stalled)}return s}rpcUnsubscribe(e,t,r){const s={method:g.getRelayProtocolApi(r.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s}),this.relayer.request(s)}onSubscribe(e,t){this.setSubscription(e,kt(Fe({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,Fe({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,r){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,r),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,Fe({},t)),this.topicMap.set(t.topic,e),this.events.emit(K.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:r}=g.getInternalError("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(r)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const r=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(r.topic,e),this.events.emit(K.deleted,kt(Fe({},r),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(K.sync)}async onRestart(){if(this.cached.length){const e=[...this.cached],t=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let r=0;r<t;r++){const s=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(s)}}this.events.emit(K.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:t}=g.getInternalError("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(e.map(t=>kt(Fe({},t),{id:this.getSubscriptionId(t.topic)}))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);const t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(await g.sleep(U(ye)),await this.relayer.handleBatchMessageEvents(t.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){!this.relayer.connected&&!this.relayer.connecting&&await this.relayer.transportOpen()}getSubscriptionId(e){return g.hashMessage(e+this.clientId)}}var Rc=Object.defineProperty,Gr=Object.getOwnPropertySymbols,Oc=Object.prototype.hasOwnProperty,Cc=Object.prototype.propertyIsEnumerable,qr=(i,e,t)=>e in i?Rc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Hr=(i,e)=>{for(var t in e||(e={}))Oc.call(e,t)&&qr(i,t,e[t]);if(Gr)for(var t of Gr(e))Cc.call(e,t)&&qr(i,t,e[t]);return i};class Yr extends ro{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new re.exports.EventEmitter,this.name=Ui,this.transportExplicitlyClosed=!1,this.initialized=!1,this.connectionAttemptInProgress=!1,this.hasExperiencedNetworkDisruption=!1,this.heartBeatTimeout=U(At+Pt),this.requestsInFlight=[],this.connectTimeout=U(ye*15),this.request=async t=>{var r,s;this.logger.debug("Publishing Request Payload");const n=t.id||Ft().toString();await this.toEstablishConnection();try{this.logger.trace({id:n,method:t.method,topic:(r=t.params)==null?void 0:r.topic},"relayer.request - publishing...");const o=`${n}:${((s=t.params)==null?void 0:s.tag)||""}`;this.requestsInFlight.push(o);const h=await this.provider.request(t);return this.requestsInFlight=this.requestsInFlight.filter(u=>u!==o),h}catch(o){throw this.logger.debug(`Failed to Publish Request: ${n}`),o}},this.resetPingTimeout=()=>{if(g.isNode())try{clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,r,s;this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(s=(r=(t=this.provider)==null?void 0:t.connection)==null?void 0:r.socket)==null||s.terminate()},this.heartBeatTimeout)}catch(t){this.logger.warn(t,t?.message)}},this.onPayloadHandler=t=>{this.onProviderPayload(t),this.resetPingTimeout()},this.onConnectHandler=()=>{this.logger.warn({},"Relayer connected \u{1F6DC}"),this.startPingTimeout(),this.events.emit($.connect)},this.onDisconnectHandler=()=>{this.logger.warn({},"Relayer disconnected \u{1F6D1}"),this.requestsInFlight=[],this.onProviderDisconnect()},this.onProviderErrorHandler=t=>{this.logger.fatal(t,`Fatal socket error: ${t?.message}`),this.events.emit($.error,t),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()},this.registerProviderListeners=()=>{this.provider.on(G.payload,this.onPayloadHandler),this.provider.on(G.connect,this.onConnectHandler),this.provider.on(G.disconnect,this.onDisconnectHandler),this.provider.on(G.error,this.onProviderErrorHandler)},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?F(e.logger,this.name):ue(Di({level:e.logger||ji})),this.messages=new Rr(this.logger,e.core),this.subscriber=new kr(this,this.logger),this.publisher=new Ec(this,this.logger),this.relayUrl=e?.relayUrl||$t,this.projectId=e.projectId,g.isAndroid()?this.packageName=g.getAppId():g.isIos()&&(this.bundleId=g.getAppId()),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.cached.length>0)try{await this.transportOpen()}catch(e){this.logger.warn(e,e?.message)}}get context(){return k(this.logger)}get connected(){var e,t,r;return((r=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:r.readyState)===1}get connecting(){var e,t,r;return((r=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:r.readyState)===0}async publish(e,t,r){this.isInitialized(),await this.publisher.publish(e,t,r),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:me.relay})}async subscribe(e,t){var r,s,n;this.isInitialized(),(!(t!=null&&t.transportType)||t?.transportType==="relay")&&await this.toEstablishConnection();const o=typeof((r=t?.internal)==null?void 0:r.throwOnFailedPublish)>"u"?!0:(s=t?.internal)==null?void 0:s.throwOnFailedPublish;let h=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",u;const c=d=>{d.topic===e&&(this.subscriber.off(K.created,c),u())};return await Promise.all([new Promise(d=>{u=d,this.subscriber.on(K.created,c)}),new Promise(async(d,p)=>{h=await this.subscriber.subscribe(e,Hr({internal:{throwOnFailedPublish:o}},t)).catch(m=>{o&&p(m)})||h,d()})]),h}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await g.createExpiringPromise(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(t,r)=>{await this.connect(e).then(t).catch(r).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await g.isOnline())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}const t=e.sort((r,s)=>r.publishedAt-s.publishedAt);this.logger.debug(`Batch of ${t.length} message events sorted`);for(const r of t)try{await this.onMessageEvent(r)}catch(s){this.logger.warn(s,"Error while processing batch message event: "+s?.message)}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){const{topic:r}=e;if(!t.sessionExists){const s=g.calcExpiry(Lt),n={topic:r,expiry:s,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(r,n)}this.events.emit($.message,e),await this.recordMessageEvent(e)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let t=1;for(;t<6;){try{this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${t}...`),await this.createProvider(),await new Promise(async(r,s)=>{const n=()=>{s(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(G.disconnect,n),await g.createExpiringPromise(new Promise((o,h)=>{this.provider.connect().then(o).catch(h)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{s(o)}).finally(()=>{this.provider.off(G.disconnect,n),clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}),await new Promise(async(o,h)=>{const u=()=>{h(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(G.disconnect,u),await this.subscriber.start().then(o).catch(h).finally(()=>{this.provider.off(G.disconnect,u)})}),this.hasExperiencedNetworkDisruption=!1,r()})}catch(r){await this.subscriber.stop();const s=r;this.logger.warn({},s.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${t}`);break}await new Promise(r=>setTimeout(r,U(t*1))),t++}}startPingTimeout(){var e,t,r,s,n;if(g.isNode())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(s=(r=this.provider)==null?void 0:r.connection)==null?void 0:s.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o?.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new pc(new Us.default(g.formatRelayRpcUrl({sdkVersion:at,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:t,message:r}=e;await this.messages.set(t,r)}async shouldIgnoreMessageEvent(e){const{topic:t,message:r}=e;if(!r||r.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${r}`),!0;if(!await this.subscriber.isSubscribed(t))return this.logger.warn(`Ignoring message for non-subscribed topic ${t}`),!0;const s=this.messages.has(t,r);return s&&this.logger.warn(`Ignoring duplicate message: ${r}`),s}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),zr(e)){if(!e.method.endsWith(Mi))return;const t=e.params,{topic:r,message:s,publishedAt:n,attestation:o}=t.data,h={topic:r,message:s,publishedAt:n,transportType:me.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Hr({type:"event",event:t.id},h)),this.events.emit(t.id,h),await this.acknowledgePayload(e),await this.onMessageEvent(h)}else Vt(e)&&this.events.emit($.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit($.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const t=xr(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(G.payload,this.onPayloadHandler),this.provider.off(G.connect,this.onConnectHandler),this.provider.off(G.disconnect,this.onDisconnectHandler),this.provider.off(G.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await g.isOnline();g.subscribeToNetworkChange(async t=>{e!==t&&(e=t,t?await this.transportOpen().catch(r=>this.logger.error(r,r?.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))})}async onProviderDisconnect(){await this.subscriber.stop(),clearTimeout(this.pingTimeout),this.events.emit($.disconnect),this.connectionAttemptInProgress=!1,!this.transportExplicitlyClosed&&(this.reconnectTimeout||this.connectPromise||(this.reconnectTimeout=setTimeout(async()=>{clearTimeout(this.reconnectTimeout),await this.transportOpen().catch(e=>this.logger.error(e,e?.message))},U(Bi))))}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){await this.confirmOnlineStateOrThrow(),!this.connected&&await this.transportOpen()}}var Gt={exports:{}};(function(i,e){var t=200,r="__lodash_hash_undefined__",s=1,n=2,o=9007199254740991,h="[object Arguments]",u="[object Array]",c="[object AsyncFunction]",d="[object Boolean]",p="[object Date]",m="[object Error]",b="[object Function]",y="[object GeneratorFunction]",_="[object Map]",S="[object Number]",I="[object Null]",D="[object Object]",L="[object Promise]",R="[object Proxy]",q="[object RegExp]",H="[object Set]",V="[object String]",ee="[object Symbol]",Pe="[object Undefined]",qt="[object WeakMap]",ls="[object ArrayBuffer]",ut="[object DataView]",Vc="[object Float32Array]",kc="[object Float64Array]",Gc="[object Int8Array]",qc="[object Int16Array]",Hc="[object Int32Array]",Yc="[object Uint8Array]",Xc="[object Uint8ClampedArray]",Wc="[object Uint16Array]",Jc="[object Uint32Array]",Zc=/[\\^$.*+?()[\]{}|]/g,Qc=/^\[object .+?Constructor\]$/,eh=/^(?:0|[1-9]\d*)$/,O={};O[Vc]=O[kc]=O[Gc]=O[qc]=O[Hc]=O[Yc]=O[Xc]=O[Wc]=O[Jc]=!0,O[h]=O[u]=O[ls]=O[d]=O[ut]=O[p]=O[m]=O[b]=O[_]=O[S]=O[D]=O[q]=O[H]=O[V]=O[qt]=!1;var us=typeof Ye=="object"&&Ye&&Ye.Object===Object&&Ye,th=typeof self=="object"&&self&&self.Object===Object&&self,ce=us||th||Function("return this")(),ds=e&&!e.nodeType&&e,gs=ds&&!0&&i&&!i.nodeType&&i,ps=gs&&gs.exports===ds,Ht=ps&&us.process,fs=function(){try{return Ht&&Ht.binding&&Ht.binding("util")}catch{}}(),ys=fs&&fs.isTypedArray;function ih(a,l){for(var f=-1,E=a==null?0:a.length,C=0,w=[];++f<E;){var A=a[f];l(A,f,a)&&(w[C++]=A)}return w}function rh(a,l){for(var f=-1,E=l.length,C=a.length;++f<E;)a[C+f]=l[f];return a}function sh(a,l){for(var f=-1,E=a==null?0:a.length;++f<E;)if(l(a[f],f,a))return!0;return!1}function nh(a,l){for(var f=-1,E=Array(a);++f<a;)E[f]=l(f);return E}function oh(a){return function(l){return a(l)}}function ah(a,l){return a.has(l)}function ch(a,l){return a?.[l]}function hh(a){var l=-1,f=Array(a.size);return a.forEach(function(E,C){f[++l]=[C,E]}),f}function lh(a,l){return function(f){return a(l(f))}}function uh(a){var l=-1,f=Array(a.size);return a.forEach(function(E){f[++l]=E}),f}var dh=Array.prototype,gh=Function.prototype,dt=Object.prototype,Yt=ce["__core-js_shared__"],ms=gh.toString,oe=dt.hasOwnProperty,vs=function(){var a=/[^.]+$/.exec(Yt&&Yt.keys&&Yt.keys.IE_PROTO||"");return a?"Symbol(src)_1."+a:""}(),bs=dt.toString,ph=RegExp("^"+ms.call(oe).replace(Zc,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Es=ps?ce.Buffer:void 0,gt=ce.Symbol,_s=ce.Uint8Array,ws=dt.propertyIsEnumerable,fh=dh.splice,ve=gt?gt.toStringTag:void 0,Ds=Object.getOwnPropertySymbols,yh=Es?Es.isBuffer:void 0,mh=lh(Object.keys,Object),Xt=Ae(ce,"DataView"),Ve=Ae(ce,"Map"),Wt=Ae(ce,"Promise"),Jt=Ae(ce,"Set"),Zt=Ae(ce,"WeakMap"),ke=Ae(Object,"create"),vh=_e(Xt),bh=_e(Ve),Eh=_e(Wt),_h=_e(Jt),wh=_e(Zt),Is=gt?gt.prototype:void 0,Qt=Is?Is.valueOf:void 0;function be(a){var l=-1,f=a==null?0:a.length;for(this.clear();++l<f;){var E=a[l];this.set(E[0],E[1])}}function Dh(){this.__data__=ke?ke(null):{},this.size=0}function Ih(a){var l=this.has(a)&&delete this.__data__[a];return this.size-=l?1:0,l}function Th(a){var l=this.__data__;if(ke){var f=l[a];return f===r?void 0:f}return oe.call(l,a)?l[a]:void 0}function Sh(a){var l=this.__data__;return ke?l[a]!==void 0:oe.call(l,a)}function Rh(a,l){var f=this.__data__;return this.size+=this.has(a)?0:1,f[a]=ke&&l===void 0?r:l,this}be.prototype.clear=Dh,be.prototype.delete=Ih,be.prototype.get=Th,be.prototype.has=Sh,be.prototype.set=Rh;function he(a){var l=-1,f=a==null?0:a.length;for(this.clear();++l<f;){var E=a[l];this.set(E[0],E[1])}}function Oh(){this.__data__=[],this.size=0}function Ch(a){var l=this.__data__,f=ft(l,a);if(f<0)return!1;var E=l.length-1;return f==E?l.pop():fh.call(l,f,1),--this.size,!0}function Ph(a){var l=this.__data__,f=ft(l,a);return f<0?void 0:l[f][1]}function Ah(a){return ft(this.__data__,a)>-1}function Lh(a,l){var f=this.__data__,E=ft(f,a);return E<0?(++this.size,f.push([a,l])):f[E][1]=l,this}he.prototype.clear=Oh,he.prototype.delete=Ch,he.prototype.get=Ph,he.prototype.has=Ah,he.prototype.set=Lh;function Ee(a){var l=-1,f=a==null?0:a.length;for(this.clear();++l<f;){var E=a[l];this.set(E[0],E[1])}}function Nh(){this.size=0,this.__data__={hash:new be,map:new(Ve||he),string:new be}}function xh(a){var l=yt(this,a).delete(a);return this.size-=l?1:0,l}function $h(a){return yt(this,a).get(a)}function zh(a){return yt(this,a).has(a)}function jh(a,l){var f=yt(this,a),E=f.size;return f.set(a,l),this.size+=f.size==E?0:1,this}Ee.prototype.clear=Nh,Ee.prototype.delete=xh,Ee.prototype.get=$h,Ee.prototype.has=zh,Ee.prototype.set=jh;function pt(a){var l=-1,f=a==null?0:a.length;for(this.__data__=new Ee;++l<f;)this.add(a[l])}function Uh(a){return this.__data__.set(a,r),this}function Mh(a){return this.__data__.has(a)}pt.prototype.add=pt.prototype.push=Uh,pt.prototype.has=Mh;function de(a){var l=this.__data__=new he(a);this.size=l.size}function Bh(){this.__data__=new he,this.size=0}function Fh(a){var l=this.__data__,f=l.delete(a);return this.size=l.size,f}function Kh(a){return this.__data__.get(a)}function Vh(a){return this.__data__.has(a)}function kh(a,l){var f=this.__data__;if(f instanceof he){var E=f.__data__;if(!Ve||E.length<t-1)return E.push([a,l]),this.size=++f.size,this;f=this.__data__=new Ee(E)}return f.set(a,l),this.size=f.size,this}de.prototype.clear=Bh,de.prototype.delete=Fh,de.prototype.get=Kh,de.prototype.has=Vh,de.prototype.set=kh;function Gh(a,l){var f=mt(a),E=!f&&ol(a),C=!f&&!E&&ei(a),w=!f&&!E&&!C&&Ns(a),A=f||E||C||w,x=A?nh(a.length,String):[],j=x.length;for(var P in a)(l||oe.call(a,P))&&!(A&&(P=="length"||C&&(P=="offset"||P=="parent")||w&&(P=="buffer"||P=="byteLength"||P=="byteOffset")||tl(P,j)))&&x.push(P);return x}function ft(a,l){for(var f=a.length;f--;)if(Cs(a[f][0],l))return f;return-1}function qh(a,l,f){var E=l(a);return mt(a)?E:rh(E,f(a))}function Ge(a){return a==null?a===void 0?Pe:I:ve&&ve in Object(a)?Qh(a):nl(a)}function Ts(a){return qe(a)&&Ge(a)==h}function Ss(a,l,f,E,C){return a===l?!0:a==null||l==null||!qe(a)&&!qe(l)?a!==a&&l!==l:Hh(a,l,f,E,Ss,C)}function Hh(a,l,f,E,C,w){var A=mt(a),x=mt(l),j=A?u:ge(a),P=x?u:ge(l);j=j==h?D:j,P=P==h?D:P;var Y=j==D,te=P==D,M=j==P;if(M&&ei(a)){if(!ei(l))return!1;A=!0,Y=!1}if(M&&!Y)return w||(w=new de),A||Ns(a)?Rs(a,l,f,E,C,w):Jh(a,l,j,f,E,C,w);if(!(f&s)){var J=Y&&oe.call(a,"__wrapped__"),Z=te&&oe.call(l,"__wrapped__");if(J||Z){var pe=J?a.value():a,le=Z?l.value():l;return w||(w=new de),C(pe,le,f,E,w)}}return M?(w||(w=new de),Zh(a,l,f,E,C,w)):!1}function Yh(a){if(!Ls(a)||rl(a))return!1;var l=Ps(a)?ph:Qc;return l.test(_e(a))}function Xh(a){return qe(a)&&As(a.length)&&!!O[Ge(a)]}function Wh(a){if(!sl(a))return mh(a);var l=[];for(var f in Object(a))oe.call(a,f)&&f!="constructor"&&l.push(f);return l}function Rs(a,l,f,E,C,w){var A=f&s,x=a.length,j=l.length;if(x!=j&&!(A&&j>x))return!1;var P=w.get(a);if(P&&w.get(l))return P==l;var Y=-1,te=!0,M=f&n?new pt:void 0;for(w.set(a,l),w.set(l,a);++Y<x;){var J=a[Y],Z=l[Y];if(E)var pe=A?E(Z,J,Y,l,a,w):E(J,Z,Y,a,l,w);if(pe!==void 0){if(pe)continue;te=!1;break}if(M){if(!sh(l,function(le,we){if(!ah(M,we)&&(J===le||C(J,le,f,E,w)))return M.push(we)})){te=!1;break}}else if(!(J===Z||C(J,Z,f,E,w))){te=!1;break}}return w.delete(a),w.delete(l),te}function Jh(a,l,f,E,C,w,A){switch(f){case ut:if(a.byteLength!=l.byteLength||a.byteOffset!=l.byteOffset)return!1;a=a.buffer,l=l.buffer;case ls:return!(a.byteLength!=l.byteLength||!w(new _s(a),new _s(l)));case d:case p:case S:return Cs(+a,+l);case m:return a.name==l.name&&a.message==l.message;case q:case V:return a==l+"";case _:var x=hh;case H:var j=E&s;if(x||(x=uh),a.size!=l.size&&!j)return!1;var P=A.get(a);if(P)return P==l;E|=n,A.set(a,l);var Y=Rs(x(a),x(l),E,C,w,A);return A.delete(a),Y;case ee:if(Qt)return Qt.call(a)==Qt.call(l)}return!1}function Zh(a,l,f,E,C,w){var A=f&s,x=Os(a),j=x.length,P=Os(l),Y=P.length;if(j!=Y&&!A)return!1;for(var te=j;te--;){var M=x[te];if(!(A?M in l:oe.call(l,M)))return!1}var J=w.get(a);if(J&&w.get(l))return J==l;var Z=!0;w.set(a,l),w.set(l,a);for(var pe=A;++te<j;){M=x[te];var le=a[M],we=l[M];if(E)var xs=A?E(we,le,M,l,a,w):E(le,we,M,a,l,w);if(!(xs===void 0?le===we||C(le,we,f,E,w):xs)){Z=!1;break}pe||(pe=M=="constructor")}if(Z&&!pe){var vt=a.constructor,bt=l.constructor;vt!=bt&&"constructor"in a&&"constructor"in l&&!(typeof vt=="function"&&vt instanceof vt&&typeof bt=="function"&&bt instanceof bt)&&(Z=!1)}return w.delete(a),w.delete(l),Z}function Os(a){return qh(a,hl,el)}function yt(a,l){var f=a.__data__;return il(l)?f[typeof l=="string"?"string":"hash"]:f.map}function Ae(a,l){var f=ch(a,l);return Yh(f)?f:void 0}function Qh(a){var l=oe.call(a,ve),f=a[ve];try{a[ve]=void 0;var E=!0}catch{}var C=bs.call(a);return E&&(l?a[ve]=f:delete a[ve]),C}var el=Ds?function(a){return a==null?[]:(a=Object(a),ih(Ds(a),function(l){return ws.call(a,l)}))}:ll,ge=Ge;(Xt&&ge(new Xt(new ArrayBuffer(1)))!=ut||Ve&&ge(new Ve)!=_||Wt&&ge(Wt.resolve())!=L||Jt&&ge(new Jt)!=H||Zt&&ge(new Zt)!=qt)&&(ge=function(a){var l=Ge(a),f=l==D?a.constructor:void 0,E=f?_e(f):"";if(E)switch(E){case vh:return ut;case bh:return _;case Eh:return L;case _h:return H;case wh:return qt}return l});function tl(a,l){return l=l??o,!!l&&(typeof a=="number"||eh.test(a))&&a>-1&&a%1==0&&a<l}function il(a){var l=typeof a;return l=="string"||l=="number"||l=="symbol"||l=="boolean"?a!=="__proto__":a===null}function rl(a){return!!vs&&vs in a}function sl(a){var l=a&&a.constructor,f=typeof l=="function"&&l.prototype||dt;return a===f}function nl(a){return bs.call(a)}function _e(a){if(a!=null){try{return ms.call(a)}catch{}try{return a+""}catch{}}return""}function Cs(a,l){return a===l||a!==a&&l!==l}var ol=Ts(function(){return arguments}())?Ts:function(a){return qe(a)&&oe.call(a,"callee")&&!ws.call(a,"callee")},mt=Array.isArray;function al(a){return a!=null&&As(a.length)&&!Ps(a)}var ei=yh||ul;function cl(a,l){return Ss(a,l)}function Ps(a){if(!Ls(a))return!1;var l=Ge(a);return l==b||l==y||l==c||l==R}function As(a){return typeof a=="number"&&a>-1&&a%1==0&&a<=o}function Ls(a){var l=typeof a;return a!=null&&(l=="object"||l=="function")}function qe(a){return a!=null&&typeof a=="object"}var Ns=ys?oh(ys):Xh;function hl(a){return al(a)?Gh(a):Wh(a)}function ll(){return[]}function ul(){return!1}i.exports=cl})(Gt,Gt.exports);var Pc=Gt.exports,Ac=Object.defineProperty,Xr=Object.getOwnPropertySymbols,Lc=Object.prototype.hasOwnProperty,Nc=Object.prototype.propertyIsEnumerable,Wr=(i,e,t)=>e in i?Ac(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Jr=(i,e)=>{for(var t in e||(e={}))Lc.call(e,t)&&Wr(i,t,e[t]);if(Xr)for(var t of Xr(e))Nc.call(e,t)&&Wr(i,t,e[t]);return i};class Zr extends so{constructor(e,t,r,s=Q,n=void 0){super(e,t,r,s),this.core=e,this.logger=t,this.name=r,this.map=new Map,this.version=Fi,this.cached=[],this.initialized=!1,this.storagePrefix=Q,this.recentlyDeleted=[],this.recentlyDeletedLimit=200,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!g.isUndefined(o)?this.map.set(this.getKey(o),o):g.isProposalStruct(o)?this.map.set(o.id,o):g.isSessionStruct(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)},this.set=async(o,h)=>{this.isInitialized(),this.map.has(o)?await this.update(o,h):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:h}),this.map.set(o,h),await this.persist())},this.get=o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o)),this.getAll=o=>(this.isInitialized(),o?this.values.filter(h=>Object.keys(o).every(u=>Pc(h[u],o[u]))):this.values),this.update=async(o,h)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:h});const u=Jr(Jr({},this.getData(o)),h);this.map.set(o,u),await this.persist()},this.delete=async(o,h)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:h}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())},this.logger=F(t,this.name),this.storagePrefix=s,this.getKey=n}get context(){return k(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){const{message:s}=g.getInternalError("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(s),new Error(s)}const{message:r}=g.getInternalError("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=g.getInternalError("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Qr{constructor(e,t){this.core=e,this.logger=t,this.name=qi,this.version=Hi,this.events=new re.exports,this.initialized=!1,this.storagePrefix=Q,this.ignoredPayloadTypes=[g.TYPE_1],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:r})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...r])]},this.create=async r=>{this.isInitialized();const s=g.generateRandomBytes32(),n=await this.core.crypto.setSymKey(s),o=g.calcExpiry(Lt),h={protocol:zi},u={topic:n,expiry:o,relay:h,active:!1,methods:r?.methods},c=g.formatUri({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:s,relay:h,expiryTimestamp:o,methods:r?.methods});return this.events.emit(Ce.create,u),this.core.expirer.set(n,o),await this.pairings.set(n,u),await this.core.relayer.subscribe(n,{transportType:r?.transportType}),{topic:n,uri:c}},this.pair=async r=>{this.isInitialized();const s=this.core.eventClient.createEvent({properties:{topic:r?.uri,trace:[ne.pairing_started]}});this.isValidPair(r,s);const{topic:n,symKey:o,relay:h,expiryTimestamp:u,methods:c}=g.parseUri(r.uri);s.props.properties.topic=n,s.addTrace(ne.pairing_uri_validation_success),s.addTrace(ne.pairing_uri_not_expired);let d;if(this.pairings.keys.includes(n)){if(d=this.pairings.get(n),s.addTrace(ne.existing_pairing),d.active)throw s.setError(ae.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);s.addTrace(ne.pairing_not_expired)}const p=u||g.calcExpiry(Lt),m={topic:n,relay:h,expiry:p,active:!1,methods:c};this.core.expirer.set(n,p),await this.pairings.set(n,m),s.addTrace(ne.store_new_pairing),r.activatePairing&&await this.activate({topic:n}),this.events.emit(Ce.create,m),s.addTrace(ne.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),s.addTrace(ne.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{s.setError(ae.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:h})}catch(b){throw s.setError(ae.subscribe_pairing_topic_failure),b}return s.addTrace(ne.subscribe_pairing_topic_success),m},this.activate=async({topic:r})=>{this.isInitialized();const s=g.calcExpiry(ot);this.core.expirer.set(r,s),await this.pairings.update(r,{active:!0,expiry:s})},this.ping=async r=>{this.isInitialized(),await this.isValidPing(r);const{topic:s}=r;if(this.pairings.keys.includes(s)){const n=await this.sendRequest(s,"wc_pairingPing",{}),{done:o,resolve:h,reject:u}=g.createDelayedPromise();this.events.once(g.engineEvent("pairing_ping",n),({error:c})=>{c?u(c):h()}),await o()}},this.updateExpiry=async({topic:r,expiry:s})=>{this.isInitialized(),await this.pairings.update(r,{expiry:s})},this.updateMetadata=async({topic:r,metadata:s})=>{this.isInitialized(),await this.pairings.update(r,{peerMetadata:s})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async r=>{this.isInitialized(),await this.isValidDisconnect(r);const{topic:s}=r;this.pairings.keys.includes(s)&&(await this.sendRequest(s,"wc_pairingDelete",g.getSdkError("USER_DISCONNECTED")),await this.deletePairing(s))},this.formatUriFromPairing=r=>{this.isInitialized();const{topic:s,relay:n,expiry:o,methods:h}=r,u=this.core.crypto.keychain.get(s);return g.formatUri({protocol:this.core.protocol,version:this.core.version,topic:s,symKey:u,relay:n,expiryTimestamp:o,methods:h})},this.sendRequest=async(r,s,n)=>{const o=Kt(s,n),h=await this.core.crypto.encode(r,o),u=Oe[s].req;return this.core.history.set(r,o),this.core.relayer.publish(r,h,u),o.id},this.sendResult=async(r,s,n)=>{const o=xr(r,n),h=await this.core.crypto.encode(s,o),u=await this.core.history.get(s,r),c=Oe[u.request.method].res;await this.core.relayer.publish(s,h,c),await this.core.history.resolve(o)},this.sendError=async(r,s,n)=>{const o=dc(r,n),h=await this.core.crypto.encode(s,o),u=await this.core.history.get(s,r),c=Oe[u.request.method]?Oe[u.request.method].res:Oe.unregistered_method.res;await this.core.relayer.publish(s,h,c),await this.core.history.resolve(o)},this.deletePairing=async(r,s)=>{await this.core.relayer.unsubscribe(r),await Promise.all([this.pairings.delete(r,g.getSdkError("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(r),s?Promise.resolve():this.core.expirer.del(r)])},this.cleanup=async()=>{const r=this.pairings.getAll().filter(s=>g.isExpired(s.expiry));await Promise.all(r.map(s=>this.deletePairing(s.topic)))},this.onRelayEventRequest=r=>{const{topic:s,payload:n}=r;switch(n.method){case"wc_pairingPing":return this.onPairingPingRequest(s,n);case"wc_pairingDelete":return this.onPairingDeleteRequest(s,n);default:return this.onUnknownRpcMethodRequest(s,n)}},this.onRelayEventResponse=async r=>{const{topic:s,payload:n}=r,o=(await this.core.history.get(s,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(s,n);default:return this.onUnknownRpcMethodResponse(o)}},this.onPairingPingRequest=async(r,s)=>{const{id:n}=s;try{this.isValidPing({topic:r}),await this.sendResult(n,r,!0),this.events.emit(Ce.ping,{id:n,topic:r})}catch(o){await this.sendError(n,r,o),this.logger.error(o)}},this.onPairingPingResponse=(r,s)=>{const{id:n}=s;setTimeout(()=>{jr(s)?this.events.emit(g.engineEvent("pairing_ping",n),{}):ht(s)&&this.events.emit(g.engineEvent("pairing_ping",n),{error:s.error})},500)},this.onPairingDeleteRequest=async(r,s)=>{const{id:n}=s;try{this.isValidDisconnect({topic:r}),await this.deletePairing(r),this.events.emit(Ce.delete,{id:n,topic:r})}catch(o){await this.sendError(n,r,o),this.logger.error(o)}},this.onUnknownRpcMethodRequest=async(r,s)=>{const{id:n,method:o}=s;try{if(this.registeredMethods.includes(o))return;const h=g.getSdkError("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,r,h),this.logger.error(h)}catch(h){await this.sendError(n,r,h),this.logger.error(h)}},this.onUnknownRpcMethodResponse=r=>{this.registeredMethods.includes(r)||this.logger.error(g.getSdkError("WC_METHOD_UNSUPPORTED",r))},this.isValidPair=(r,s)=>{var n;if(!g.isValidParams(r)){const{message:h}=g.getInternalError("MISSING_OR_INVALID",`pair() params: ${r}`);throw s.setError(ae.malformed_pairing_uri),new Error(h)}if(!g.isValidUrl(r.uri)){const{message:h}=g.getInternalError("MISSING_OR_INVALID",`pair() uri: ${r.uri}`);throw s.setError(ae.malformed_pairing_uri),new Error(h)}const o=g.parseUri(r?.uri);if(!((n=o?.relay)!=null&&n.protocol)){const{message:h}=g.getInternalError("MISSING_OR_INVALID","pair() uri#relay-protocol");throw s.setError(ae.malformed_pairing_uri),new Error(h)}if(!(o!=null&&o.symKey)){const{message:h}=g.getInternalError("MISSING_OR_INVALID","pair() uri#symKey");throw s.setError(ae.malformed_pairing_uri),new Error(h)}if(o!=null&&o.expiryTimestamp&&U(o?.expiryTimestamp)<Date.now()){s.setError(ae.pairing_expired);const{message:h}=g.getInternalError("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(h)}},this.isValidPing=async r=>{if(!g.isValidParams(r)){const{message:n}=g.getInternalError("MISSING_OR_INVALID",`ping() params: ${r}`);throw new Error(n)}const{topic:s}=r;await this.isValidPairingTopic(s)},this.isValidDisconnect=async r=>{if(!g.isValidParams(r)){const{message:n}=g.getInternalError("MISSING_OR_INVALID",`disconnect() params: ${r}`);throw new Error(n)}const{topic:s}=r;await this.isValidPairingTopic(s)},this.isValidPairingTopic=async r=>{if(!g.isValidString(r,!1)){const{message:s}=g.getInternalError("MISSING_OR_INVALID",`pairing topic should be a string: ${r}`);throw new Error(s)}if(!this.pairings.keys.includes(r)){const{message:s}=g.getInternalError("NO_MATCHING_KEY",`pairing topic doesn't exist: ${r}`);throw new Error(s)}if(g.isExpired(this.pairings.get(r).expiry)){await this.deletePairing(r);const{message:s}=g.getInternalError("EXPIRED",`pairing topic: ${r}`);throw new Error(s)}},this.core=e,this.logger=F(t,this.name),this.pairings=new Zr(this.core,this.logger,this.name,this.storagePrefix)}get context(){return k(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on($.message,async e=>{const{topic:t,message:r,transportType:s}=e;if(!this.pairings.keys.includes(t)||s===me.link_mode||this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(r)))return;const n=await this.core.crypto.decode(t,r);try{zr(n)?(this.core.history.set(t,n),this.onRelayEventRequest({topic:t,payload:n})):Vt(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id))}catch(o){this.logger.error(o)}})}registerExpirerEvents(){this.core.expirer.on(W.expired,async e=>{const{topic:t}=g.parseExpirerTarget(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Ce.expire,{topic:t}))})}}class es extends eo{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new re.exports.EventEmitter,this.name=Yi,this.version=Xi,this.cached=[],this.initialized=!1,this.storagePrefix=Q,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(r=>this.records.set(r.id,r)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(r,s,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:r,request:s,chainId:n}),this.records.has(s.id))return;const o={id:s.id,topic:r,request:{method:s.method,params:s.params||null},chainId:n,expiry:g.calcExpiry(ot)};this.records.set(o.id,o),this.persist(),this.events.emit(X.created,o)},this.resolve=async r=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:r}),!this.records.has(r.id))return;const s=await this.getRecord(r.id);typeof s.response>"u"&&(s.response=ht(r)?{error:r.error}:{result:r.result},this.records.set(s.id,s),this.persist(),this.events.emit(X.updated,s))},this.get=async(r,s)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:r,id:s}),await this.getRecord(s)),this.delete=(r,s)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:s}),this.values.forEach(n=>{if(n.topic===r){if(typeof s<"u"&&n.id!==s)return;this.records.delete(n.id),this.events.emit(X.deleted,n)}}),this.persist()},this.exists=async(r,s)=>(this.isInitialized(),this.records.has(s)?(await this.getRecord(s)).topic===r:!1),this.on=(r,s)=>{this.events.on(r,s)},this.once=(r,s)=>{this.events.once(r,s)},this.off=(r,s)=>{this.events.off(r,s)},this.removeListener=(r,s)=>{this.events.removeListener(r,s)},this.logger=F(t,this.name)}get context(){return k(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const r={topic:t.topic,request:Kt(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(r)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:r}=g.getInternalError("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(r)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(X.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=g.getInternalError("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(X.created,e=>{const t=X.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(X.updated,e=>{const t=X.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(X.deleted,e=>{const t=X.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(ie.HEARTBEAT_EVENTS.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{U(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(X.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}}class ts extends oo{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new re.exports.EventEmitter,this.name=Wi,this.version=Ji,this.cached=[],this.initialized=!1,this.storagePrefix=Q,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(r=>this.expirations.set(r.target,r)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=r=>{try{const s=this.formatTarget(r);return typeof this.getExpiration(s)<"u"}catch{return!1}},this.set=(r,s)=>{this.isInitialized();const n=this.formatTarget(r),o={target:n,expiry:s};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit(W.created,{target:n,expiration:o})},this.get=r=>{this.isInitialized();const s=this.formatTarget(r);return this.getExpiration(s)},this.del=r=>{if(this.isInitialized(),this.has(r)){const s=this.formatTarget(r),n=this.getExpiration(s);this.expirations.delete(s),this.events.emit(W.deleted,{target:s,expiration:n})}},this.on=(r,s)=>{this.events.on(r,s)},this.once=(r,s)=>{this.events.once(r,s)},this.off=(r,s)=>{this.events.off(r,s)},this.removeListener=(r,s)=>{this.events.removeListener(r,s)},this.logger=F(t,this.name)}get context(){return k(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return g.formatTopicTarget(e);if(typeof e=="number")return g.formatIdTarget(e);const{message:t}=g.getInternalError("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(W.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=g.getInternalError("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:r}=g.getInternalError("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(r),new Error(r)}return t}checkExpiry(e,t){const{expiry:r}=t;U(r)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(W.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(ie.HEARTBEAT_EVENTS.pulse,()=>this.checkExpirations()),this.events.on(W.created,e=>{const t=W.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(W.expired,e=>{const t=W.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(W.deleted,e=>{const t=W.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=g.getInternalError("NOT_INITIALIZED",this.name);throw new Error(e)}}}function xc(i){let e;return typeof window<"u"&&typeof window[i]<"u"&&(e=window[i]),e}function $c(){return xc("document")}class is extends ao{constructor(e,t,r){super(e,t,r),this.core=e,this.logger=t,this.store=r,this.name=Zi,this.verifyUrlV3=er,this.storagePrefix=Q,this.version=Ct,this.init=async()=>{var s;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&U((s=this.publicKey)==null?void 0:s.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))},this.register=async s=>{if(!g.isBrowser()||this.isDevEnv)return;const n=window.location.origin,{id:o,decryptedId:h}=s,u=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${h}`;try{const c=$c(),d=this.startAbortTimer(ye*5),p=await new Promise((m,b)=>{const y=()=>{window.removeEventListener("message",S),c.body.removeChild(_),b("attestation aborted")};this.abortController.signal.addEventListener("abort",y);const _=c.createElement("iframe");_.src=u,_.style.display="none",_.addEventListener("error",y,{signal:this.abortController.signal});const S=I=>{if(I.data&&typeof I.data=="string")try{const D=JSON.parse(I.data);if(D.type==="verify_attestation"){if(Et.decodeJWT(D.attestation).payload.id!==o)return;clearInterval(d),c.body.removeChild(_),this.abortController.signal.removeEventListener("abort",y),window.removeEventListener("message",S),m(D.attestation===null?"":D.attestation)}}catch(D){this.logger.warn(D)}};c.body.appendChild(_),window.addEventListener("message",S,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",p),p}catch(c){this.logger.warn(c)}return""},this.resolve=async s=>{if(this.isDevEnv)return"";const{attestationId:n,hash:o,encryptedId:h}=s;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(Et.decodeJWT(n).payload.id!==h)return;const c=await this.isValidJwtAttestation(n);if(c){if(!c.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return c}}if(!o)return;const u=this.getVerifyUrl(s?.verifyUrl);return this.fetchAttestation(o,u)},this.fetchAttestation=async(s,n)=>{this.logger.debug(`resolving attestation: ${s} from url: ${n}`);const o=this.startAbortTimer(ye*5),h=await fetch(`${n}/attestation/${s}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),h.status===200?await h.json():void 0},this.getVerifyUrl=s=>{let n=s||Ue;return tr.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${Ue}`),n=Ue),n},this.fetchPublicKey=async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);const s=this.startAbortTimer(Pt),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(s),await n.json()}catch(s){this.logger.warn(s)}},this.persistPublicKey=async s=>{this.logger.debug("persisting public key to local storage",s),await this.store.setItem(this.storeKey,s),this.publicKey=s},this.removePublicKey=async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0},this.isValidJwtAttestation=async s=>{const n=await this.getPublicKey();try{if(n)return this.validateAttestation(s,n)}catch(h){this.logger.error(h),this.logger.warn("error validating attestation")}const o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(s,o)}catch(h){this.logger.error(h),this.logger.warn("error validating attestation")}},this.getPublicKey=async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey(),this.fetchAndPersistPublicKey=async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{const o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});const s=await this.fetchPromise;return this.fetchPromise=void 0,s},this.validateAttestation=(s,n)=>{const o=g.verifyP256Jwt(s,n.publicKey),h={hasExpired:U(o.exp)<Date.now(),payload:o};if(h.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:h.payload.origin,isScam:h.payload.isScam,isVerified:h.payload.isVerified}},this.logger=F(t,this.name),this.abortController=new AbortController,this.isDevEnv=g.isTestRun(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return k(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),U(e))}}class rs extends co{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.context=ir,this.registerDeviceToken=async r=>{const{clientId:s,token:n,notificationType:o,enableEncrypted:h=!1}=r,u=`${rr}/${this.projectId}/clients`;await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:s,type:o,token:n,always_raw:h})})},this.logger=F(t,this.context)}}var zc=Object.defineProperty,ss=Object.getOwnPropertySymbols,jc=Object.prototype.hasOwnProperty,Uc=Object.prototype.propertyIsEnumerable,ns=(i,e,t)=>e in i?zc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ke=(i,e)=>{for(var t in e||(e={}))jc.call(e,t)&&ns(i,t,e[t]);if(ss)for(var t of ss(e))Uc.call(e,t)&&ns(i,t,e[t]);return i};class os extends ho{constructor(e,t,r=!0){super(e,t,r),this.core=e,this.logger=t,this.context=nr,this.storagePrefix=Q,this.storageVersion=sr,this.events=new Map,this.shouldPersist=!1,this.init=async()=>{if(!g.isTestRun())try{const s={eventId:g.uuidv4(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:g.formatUA(this.core.relayer.protocol,this.core.relayer.version,at)}}};await this.sendEvent([s])}catch(s){this.logger.warn(s)}},this.createEvent=s=>{const{event:n="ERROR",type:o="",properties:{topic:h,trace:u}}=s,c=g.uuidv4(),d=this.core.projectId||"",p=Date.now(),m=Ke({eventId:c,timestamp:p,props:{event:n,type:o,properties:{topic:h,trace:u}},bundleId:d,domain:this.getAppDomain()},this.setMethods(c));return this.telemetryEnabled&&(this.events.set(c,m),this.shouldPersist=!0),m},this.getEvent=s=>{const{eventId:n,topic:o}=s;if(n)return this.events.get(n);const h=Array.from(this.events.values()).find(u=>u.props.properties.topic===o);if(h)return Ke(Ke({},h),this.setMethods(h.eventId))},this.deleteEvent=s=>{const{eventId:n}=s;this.events.delete(n),this.shouldPersist=!0},this.setEventListeners=()=>{this.core.heartbeat.on(ie.HEARTBEAT_EVENTS.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(s=>{Oi(Date.now())-Oi(s.timestamp)>or&&(this.events.delete(s.eventId),this.shouldPersist=!0)})})},this.setMethods=s=>({addTrace:n=>this.addTrace(s,n),setError:n=>this.setError(s,n)}),this.addTrace=(s,n)=>{const o=this.events.get(s);o&&(o.props.properties.trace.push(n),this.events.set(s,o),this.shouldPersist=!0)},this.setError=(s,n)=>{const o=this.events.get(s);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(s,o),this.shouldPersist=!0)},this.persist=async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1},this.restore=async()=>{try{const s=await this.core.storage.getItem(this.storageKey)||[];if(!s.length)return;s.forEach(n=>{this.events.set(n.eventId,Ke(Ke({},n),this.setMethods(n.eventId)))})}catch(s){this.logger.warn(s)}},this.submit=async()=>{if(!this.telemetryEnabled||this.events.size===0)return;const s=[];for(const[n,o]of this.events)o.props.type&&s.push(o);if(s.length!==0)try{if((await this.sendEvent(s)).ok)for(const n of s)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}},this.sendEvent=async s=>{const n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${ar}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${at}${n}`,{method:"POST",body:JSON.stringify(s)})},this.getAppDomain=()=>g.getAppMetadata().url,this.logger=F(t,this.context),this.telemetryEnabled=r,r?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}}var Mc=Object.defineProperty,as=Object.getOwnPropertySymbols,Bc=Object.prototype.hasOwnProperty,Fc=Object.prototype.propertyIsEnumerable,cs=(i,e,t)=>e in i?Mc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,hs=(i,e)=>{for(var t in e||(e={}))Bc.call(e,t)&&cs(i,t,e[t]);if(as)for(var t of as(e))Fc.call(e,t)&&cs(i,t,e[t]);return i};class lt extends Qn{constructor(e){var t;super(e),this.protocol=Ot,this.version=Ct,this.name=je,this.events=new re.exports.EventEmitter,this.initialized=!1,this.on=(o,h)=>this.events.on(o,h),this.once=(o,h)=>this.events.once(o,h),this.off=(o,h)=>this.events.off(o,h),this.removeListener=(o,h)=>this.events.removeListener(o,h),this.dispatchEnvelope=({topic:o,message:h,sessionExists:u})=>{if(!o||!h)return;const c={topic:o,message:h,publishedAt:Date.now(),transportType:me.link_mode};this.relayer.onLinkMessageEvent(c,{sessionExists:u})},this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||$t,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";const r=Di({level:typeof e?.logger=="string"&&e.logger?e.logger:Ii.logger,name:je}),{logger:s,chunkLoggerController:n}=Zn({opts:r,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=n,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var o,h;(o=this.logChunkController)!=null&&o.downloadLogsBlobInBrowser&&((h=this.logChunkController)==null||h.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=F(s,this.name),this.heartbeat=new ie.HeartBeat,this.crypto=new Sr(this,this.logger,e?.keychain),this.history=new es(this,this.logger),this.expirer=new ts(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new In(hs(hs({},Ti),e?.storageOptions)),this.relayer=new Yr({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new Qr(this,this.logger),this.verify=new is(this,this.logger,this.storage),this.echoClient=new rs(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new os(this,this.logger,e?.telemetryEnabled)}static async init(e){const t=new lt(e);await t.initialize();const r=await t.crypto.getClientId();return await t.storage.setItem(Ki,r),t}get context(){return k(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(zt,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.eventClient.init(),this.linkModeSupportedApps=await this.storage.getItem(zt)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}}const Kc=lt;v.CORE_CONTEXT=je,v.CORE_DEFAULT=Ii,v.CORE_PROTOCOL=Ot,v.CORE_STORAGE_OPTIONS=Ti,v.CORE_STORAGE_PREFIX=Q,v.CORE_VERSION=Ct,v.CRYPTO_CLIENT_SEED=Nt,v.CRYPTO_CONTEXT=Ci,v.CRYPTO_JWT_TTL=Pi,v.Core=Kc,v.Crypto=Sr,v.ECHO_CONTEXT=ir,v.ECHO_URL=rr,v.EVENTS_CLIENT_API_URL=ar,v.EVENTS_STORAGE_CLEANUP_INTERVAL=or,v.EVENTS_STORAGE_CONTEXT=nr,v.EVENTS_STORAGE_VERSION=sr,v.EVENT_CLIENT_AUTHENTICATE_ERRORS=Do,v.EVENT_CLIENT_AUTHENTICATE_TRACES=wo,v.EVENT_CLIENT_CONTEXT=bo,v.EVENT_CLIENT_PAIRING_ERRORS=ae,v.EVENT_CLIENT_PAIRING_TRACES=ne,v.EVENT_CLIENT_SESSION_ERRORS=_o,v.EVENT_CLIENT_SESSION_TRACES=Eo,v.EXPIRER_CONTEXT=Wi,v.EXPIRER_DEFAULT_TTL=mo,v.EXPIRER_EVENTS=W,v.EXPIRER_STORAGE_VERSION=Ji,v.EchoClient=rs,v.EventClient=os,v.Expirer=ts,v.HISTORY_CONTEXT=Yi,v.HISTORY_EVENTS=X,v.HISTORY_STORAGE_VERSION=Xi,v.JsonRpcHistory=es,v.KEYCHAIN_CONTEXT=Ai,v.KEYCHAIN_STORAGE_VERSION=Li,v.KeyChain=Tr,v.MESSAGES_CONTEXT=Ni,v.MESSAGES_STORAGE_VERSION=xi,v.MessageTracker=Rr,v.PAIRING_CONTEXT=qi,v.PAIRING_DEFAULT_TTL=yo,v.PAIRING_EVENTS=Ce,v.PAIRING_RPC_OPTS=Oe,v.PAIRING_STORAGE_VERSION=Hi,v.PENDING_SUB_RESOLUTION_TIMEOUT=Gi,v.PUBLISHER_CONTEXT=$i,v.PUBLISHER_DEFAULT_TTL=xt,v.Pairing=Qr,v.RELAYER_CONTEXT=Ui,v.RELAYER_DEFAULT_LOGGER=ji,v.RELAYER_DEFAULT_PROTOCOL=zi,v.RELAYER_DEFAULT_RELAY_URL=$t,v.RELAYER_EVENTS=$,v.RELAYER_PROVIDER_EVENTS=G,v.RELAYER_RECONNECT_TIMEOUT=Bi,v.RELAYER_SDK_VERSION=at,v.RELAYER_STORAGE_OPTIONS=go,v.RELAYER_SUBSCRIBER_SUFFIX=Mi,v.RELAYER_TRANSPORT_CUTOFF=po,v.Relayer=Yr,v.STORE_STORAGE_VERSION=Fi,v.SUBSCRIBER_CONTEXT=Vi,v.SUBSCRIBER_DEFAULT_TTL=fo,v.SUBSCRIBER_EVENTS=K,v.SUBSCRIBER_STORAGE_VERSION=ki,v.Store=Zr,v.Subscriber=kr,v.TRANSPORT_TYPES=me,v.TRUSTED_VERIFY_URLS=tr,v.VERIFY_CONTEXT=Zi,v.VERIFY_SERVER=Ue,v.VERIFY_SERVER_V3=er,v.Verify=is,v.WALLETCONNECT_CLIENT_ID=Ki,v.WALLETCONNECT_LINK_MODE_APPS=zt,v.default=lt,Object.defineProperty(v,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.js.map
